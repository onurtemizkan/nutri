// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations and direct access
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Optional for OAuth users (Apple, Google, etc.)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // OAuth providers
  appleId   String?  @unique

  // Account status
  isActive  Boolean  @default(true)  // Can be set to false to disable account

  // Password reset
  resetToken          String?
  resetTokenExpiresAt DateTime?

  // User profile data
  profilePicture  String?  // Base64 data URL for profile picture
  dateOfBirth     DateTime?
  biologicalSex   BiologicalSex?
  goalCalories    Int      @default(2000)
  goalProtein     Float    @default(150)
  goalCarbs       Float    @default(200)
  goalFat         Float    @default(65)
  goalWater       Int      @default(2000) // Daily water goal in ml (default 2L)
  currentWeight   Float?
  goalWeight      Float?
  height          Float?
  activityLevel   String   @default("moderate") // sedentary, light, moderate, active, veryActive
  primaryGoal     PrimaryGoal?
  dietaryPreferences Json?  // ["vegetarian", "gluten_free", ...]

  // Subscription
  subscriptionTier        SubscriptionTier @default(FREE)
  subscriptionBillingCycle BillingCycle?   // Only set for PRO tier
  subscriptionStartDate   DateTime?        // When the current subscription started
  subscriptionEndDate     DateTime?        // When trial/subscription ends
  subscriptionPrice       Float?           // Price paid for Pro subscription

  meals           Meal[]
  waterIntakes    WaterIntake[]
  weightRecords   WeightRecord[]

  // ML Relations
  healthMetrics   HealthMetric[]
  activities      Activity[]
  mlFeatures      MLFeature[]
  mlPredictions   MLPrediction[]
  mlInsights      MLInsight[]
  mlProfile       UserMLProfile?

  // Supplements
  supplements     Supplement[]
  supplementLogs  SupplementLog[]

  // Notifications
  deviceTokens            DeviceToken[]
  notificationPreference  NotificationPreference?
  notificationLogs        NotificationLog[]

  // Timezone for notification scheduling
  timezone        String?   // IANA timezone (e.g., "America/New_York", "Europe/London")

  // Onboarding Relations
  onboarding      UserOnboarding?
  healthBackground UserHealthBackground?
  lifestyle       UserLifestyle?
  permissions     UserPermissions?

  // IAP Subscription
  subscription    Subscription?

  // CGM Integration
  glucoseReadings GlucoseReading[]
  cgmConnections  CGMConnection[]

  // GDPR Compliance
  consents             UserConsent[]
  dataExportRequests   DataExportRequest[]
  dataDeletionRequests DataDeletionRequest[]
  privacySettings      PrivacySettings?

  // Email Marketing
  emailPreference      EmailPreference?

  @@index([email])
  @@index([appleId])
  @@index([resetToken])
}

model Meal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  mealType    String   // breakfast, lunch, dinner, snack
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  fiber       Float?
  sugar       Float?

  // Fat breakdown (optional)
  saturatedFat       Float?  // grams
  transFat           Float?  // grams
  cholesterol        Float?  // mg

  // Minerals (optional) - values in mg unless noted
  sodium             Float?  // mg
  potassium          Float?  // mg
  calcium            Float?  // mg
  iron               Float?  // mg
  magnesium          Float?  // mg
  zinc               Float?  // mg
  phosphorus         Float?  // mg

  // Vitamins (optional) - values in appropriate units
  vitaminA           Float?  // mcg RAE
  vitaminC           Float?  // mg
  vitaminD           Float?  // mcg
  vitaminE           Float?  // mg
  vitaminK           Float?  // mcg
  vitaminB6          Float?  // mg
  vitaminB12         Float?  // mcg
  folate             Float?  // mcg DFE
  thiamin            Float?  // mg (B1)
  riboflavin         Float?  // mg (B2)
  niacin             Float?  // mg (B3)

  servingSize String?
  notes       String?
  imageUrl    String?

  consumedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // CGM Integration
  glucoseResponse MealGlucoseResponse?

  @@index([userId, consumedAt])
  @@index([userId, mealType])
}

model WaterIntake {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount    Float    // in ml
  recordedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, recordedAt])
}

model WeightRecord {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  weight    Float    // in kg
  recordedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, recordedAt])
}

// ============================================================================
// ML ENGINE MODELS
// ============================================================================

// Health Metrics - Time series data from wearables (RHR, HRV, sleep, etc.)
model HealthMetric {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamp (UTC, precise to second)
  recordedAt      DateTime

  // Metric type (enum for type safety)
  metricType      HealthMetricType

  // Value (flexible for different units)
  value           Float
  unit            String            // "bpm", "ms", "%", "steps", "kcal", etc.

  // Source (for data provenance)
  source          String            // "apple_health", "fitbit", "garmin", "oura", "whoop", "manual"
  sourceId        String?           // Original ID from source system

  // Metadata (JSON for flexibility)
  metadata        Json?             // {quality: "high", confidence: 0.95, device: "Apple Watch Series 9"}

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, recordedAt])
  @@index([userId, metricType, recordedAt])
  @@unique([userId, metricType, recordedAt, source])
}

// Activity - Exercise and movement data
model Activity {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timing
  startedAt       DateTime
  endedAt         DateTime
  duration        Int               // Duration in minutes

  // Type & Intensity
  activityType    ActivityType
  intensity       ActivityIntensity

  // Metrics
  caloriesBurned  Float?
  averageHeartRate Float?
  maxHeartRate    Float?
  distance        Float?            // In meters
  steps           Int?

  // Source
  source          String            // "apple_health", "strava", "garmin", "manual"
  sourceId        String?

  // Notes
  notes           String?

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, startedAt])
  @@index([userId, activityType, startedAt])
}

// ML Features - Pre-computed features for fast predictions
model MLFeature {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Temporal scope
  date            DateTime          // Date this feature represents (e.g., 2025-01-17)

  // Feature category
  category        MLFeatureCategory

  // Features (JSON for flexibility)
  features        Json              // {protein_7d_avg: 150, carbs_ratio: 0.4, meal_regularity: 0.85}

  // Metadata
  version         String            // "v1.2.3" - for feature engineering versioning

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, date, category])
  @@unique([userId, date, category, version])
}

// ML Predictions - Model outputs and tracking
model MLPrediction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What are we predicting?
  targetMetric    HealthMetricType
  targetDate      DateTime          // When is this prediction for?

  // Prediction
  predictedValue  Float
  confidence      Float             // 0.0 to 1.0
  predictionRange Json              // {lower: 55, upper: 61} for confidence intervals

  // Model metadata
  modelId         String            // "rhr_lstm_v2.1.0"
  modelVersion    String            // "2.1.0"

  // Feature importance (what drove this prediction?)
  featureImportance Json            // {protein_intake: 0.35, sleep_quality: 0.28, ...}

  // Actual outcome (for model evaluation)
  actualValue     Float?
  predictionError Float?            // Calculated after actual value is recorded

  // Audit
  createdAt       DateTime          @default(now())

  @@index([userId, targetDate, targetMetric])
  @@index([userId, modelId, createdAt])
}

// ML Insights - Actionable recommendations for users
model MLInsight {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Insight type
  insightType     MLInsightType
  priority        InsightPriority

  // Content
  title           String            // "Your carb timing affects sleep quality"
  description     String            // Detailed explanation
  recommendation  String            // "Try eating complex carbs earlier in the day"

  // Supporting data
  correlation     Float?            // Correlation coefficient (if applicable)
  confidence      Float             // How confident is the ML model? (0.0 to 1.0)
  dataPoints      Int               // How many data points support this insight?

  // Metadata
  metadata        Json?             // {chart_data: [...], references: [...]}

  // User interaction
  viewed          Boolean           @default(false)
  viewedAt        DateTime?
  dismissed       Boolean           @default(false)
  dismissedAt     DateTime?
  helpful         Boolean?          // User feedback: was this helpful?

  // Audit
  createdAt       DateTime          @default(now())
  expiresAt       DateTime?         // Some insights are time-sensitive

  @@index([userId, createdAt])
  @@index([userId, insightType, priority])
}

// User ML Profile - Per-user model configuration
model UserMLProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Data quality
  totalDataPoints Int      @default(0)
  dataQualityScore Float   @default(0.0) // 0.0 to 1.0

  // Minimum data requirements met?
  hasMinimumNutritionData   Boolean @default(false)
  hasMinimumHealthData      Boolean @default(false)
  hasMinimumActivityData    Boolean @default(false)

  // Model readiness
  modelsAvailable Json     // {rhr_prediction: true, hrv_prediction: false, ...}
  lastTrainingDate DateTime?

  // User preferences
  enablePredictions Boolean @default(true)
  enableInsights    Boolean @default(true)
  insightFrequency  String  @default("daily") // "daily", "weekly", "realtime"

  // Privacy
  shareDataForResearch Boolean @default(false)
  dataRetentionDays    Int     @default(365)

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// FOOD FEEDBACK (ML Learning Loop)
// ============================================================================

// FoodFeedback - User corrections when food classification is wrong
model FoodFeedback {
  id                  String    @id @default(cuid())
  userId              String?
  imageHash           String
  classificationId    String?
  originalPrediction  String
  originalConfidence  Float
  originalCategory    String?
  selectedFdcId       Int
  selectedFoodName    String
  wasCorrect          Boolean
  classificationHints Json?
  userDescription     String?
  status              String    @default("pending") // pending, approved, rejected, applied

  createdAt           DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([originalPrediction])
  @@unique([imageHash, originalPrediction, selectedFdcId])
}

// FoodFeedbackAggregation - Aggregated patterns for model improvement
model FoodFeedbackAggregation {
  id                  String    @id @default(cuid())
  originalPrediction  String
  correctedFood       String
  correctionCount     Int       @default(0)
  avgConfidence       Float     @default(0)
  needsReview         Boolean   @default(false)
  reviewedAt          DateTime?
  firstOccurrence     DateTime
  lastOccurrence      DateTime

  @@unique([originalPrediction, correctedFood])
  @@index([needsReview, reviewedAt])
  @@index([correctionCount])
}

// LearnedPrompt - AI prompts learned from user feedback for CLIP classification
model LearnedPrompt {
  id            Int       @id @default(autoincrement())
  foodKey       String    @db.VarChar(100)
  prompt        String    @db.Text
  source        String    @db.VarChar(50)  // user_description, auto_generated, admin
  timesUsed     Int       @default(0)
  successCount  Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([foodKey, isActive])
}

// ============================================================================
// SUPPLEMENT TRACKING
// ============================================================================

// Supplement - Definition of a supplement the user takes
model Supplement {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name            String              // e.g., "Vitamin D3", "Fish Oil", "Magnesium"
  brand           String?             // Optional brand name

  // Dosage
  dosageAmount    Float               // e.g., 1000, 2, 500
  dosageUnit      String              // e.g., "IU", "mg", "mcg", "g", "capsules", "tablets"

  // Schedule
  frequency       SupplementFrequency @default(DAILY)
  timesPerDay     Int                 @default(1) // How many times per day (for DAILY frequency)
  timeOfDay       SupplementTimeOfDay[] // When to take (morning, afternoon, evening, etc.)
  withFood        Boolean             @default(false) // Should be taken with food

  // Status
  isActive        Boolean             @default(true) // Currently taking this supplement
  startDate       DateTime            @default(now())
  endDate         DateTime?           // When they stopped taking it (null if still active)

  // Additional info
  notes           String?             // Any notes about the supplement
  color           String?             // Optional color for UI display (hex code)

  // Micronutrient content (estimated or from barcode)
  // Vitamins (optional)
  vitaminA        Float?              // mcg RAE
  vitaminC        Float?              // mg
  vitaminD        Float?              // mcg
  vitaminE        Float?              // mg
  vitaminK        Float?              // mcg
  vitaminB6       Float?              // mg
  vitaminB12      Float?              // mcg
  folate          Float?              // mcg DFE
  thiamin         Float?              // mg (B1)
  riboflavin      Float?              // mg (B2)
  niacin          Float?              // mg (B3)

  // Minerals (optional)
  calcium         Float?              // mg
  iron            Float?              // mg
  magnesium       Float?              // mg
  zinc            Float?              // mg
  potassium       Float?              // mg
  sodium          Float?              // mg
  phosphorus      Float?              // mg

  // Special nutrients (optional)
  omega3          Float?              // mg (total EPA + DHA)

  // Relations
  logs            SupplementLog[]

  // Audit
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, isActive])
  @@index([userId, createdAt])
}

// SupplementLog - Record of when a supplement was taken
model SupplementLog {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplementId    String
  supplement      Supplement  @relation(fields: [supplementId], references: [id], onDelete: Cascade)

  // When it was taken
  takenAt         DateTime    @default(now())

  // Optional details
  dosageAmount    Float?      // Override if different from standard dose
  notes           String?     // Any notes for this specific dose
  skipped         Boolean     @default(false) // Marked as intentionally skipped

  // Audit
  createdAt       DateTime    @default(now())

  @@index([userId, takenAt])
  @@index([supplementId, takenAt])
  @@index([userId, supplementId, takenAt])
}

// ============================================================================
// ONBOARDING MODELS
// ============================================================================

// Tracks user onboarding progress and completion
model UserOnboarding {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Progress tracking
  currentStep     Int       @default(1)
  totalSteps      Int       @default(6)
  completedAt     DateTime?
  skippedSteps    Int[]     @default([])

  // Onboarding version (for A/B testing and migrations)
  version         String    @default("1.0")

  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

// User health background: conditions, medications, supplements
model UserHealthBackground {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stored as JSON for flexibility during iteration
  // Structure: [{type: "diabetes", subtype: "type2", diagnosedYear: 2020}]
  chronicConditions Json?

  // Structure: [{name: "metformin", dosage: "500mg", frequency: "daily", category: "diabetes"}]
  medications     Json?

  // Structure: [{name: "vitamin_d", dosage: "2000IU", frequency: "daily", category: "vitamin"}]
  supplements     Json?

  // Structure: ["peanuts", "shellfish", "dairy"]
  allergies       Json?

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// User lifestyle factors that may affect health metrics
model UserLifestyle {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Nicotine
  nicotineUse     NicotineUseLevel?
  nicotineType    String?              // "cigarettes", "vape", "chewing", "other"

  // Alcohol
  alcoholUse      AlcoholUseLevel?

  // Caffeine (cups per day of coffee/tea equivalent)
  caffeineDaily   Int?

  // Sleep patterns
  typicalBedtime  String?              // "22:30" (24h format)
  typicalWakeTime String?              // "06:30" (24h format)
  sleepQuality    Int?                 // 1-10 self-reported

  // Stress
  stressLevel     Int?                 // 1-10 self-reported

  // Work/lifestyle
  workSchedule    String?              // "regular", "shift", "irregular"

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// User permission settings for app features
model UserPermissions {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Push notifications
  notificationsEnabled  Boolean  @default(false)
  notificationTypes     Json?    // ["meal_reminders", "insights", "goals", "weekly_summary"]

  // Health data integrations
  healthKitEnabled      Boolean  @default(false)
  healthKitScopes       Json?    // ["heartRate", "steps", "sleep", "weight", ...]
  healthConnectEnabled  Boolean  @default(false)
  healthConnectScopes   Json?    // Android Health Connect scopes

  // Privacy settings
  shareAnonymousData    Boolean  @default(false)

  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// ENUMS
// ============================================================================

enum SupplementFrequency {
  DAILY
  TWICE_DAILY
  THREE_TIMES_DAILY
  WEEKLY
  EVERY_OTHER_DAY
  AS_NEEDED
}

enum SupplementTimeOfDay {
  MORNING
  AFTERNOON
  EVENING
  BEFORE_BED
  WITH_BREAKFAST
  WITH_LUNCH
  WITH_DINNER
  EMPTY_STOMACH
}

enum SubscriptionTier {
  FREE
  PRO_TRIAL
  PRO
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum BiologicalSex {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum PrimaryGoal {
  WEIGHT_LOSS
  MUSCLE_GAIN
  MAINTENANCE
  GENERAL_HEALTH
  ATHLETIC_PERFORMANCE
  BETTER_SLEEP
  STRESS_REDUCTION
}

enum NicotineUseLevel {
  NONE
  OCCASIONAL
  DAILY
  HEAVY
}

enum AlcoholUseLevel {
  NONE
  OCCASIONAL
  MODERATE
  FREQUENT
}

enum HealthMetricType {
  // Cardiovascular
  RESTING_HEART_RATE
  HEART_RATE_VARIABILITY_SDNN
  HEART_RATE_VARIABILITY_RMSSD
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC

  // Respiratory
  RESPIRATORY_RATE
  OXYGEN_SATURATION
  VO2_MAX

  // Sleep
  SLEEP_DURATION
  DEEP_SLEEP_DURATION
  REM_SLEEP_DURATION
  SLEEP_EFFICIENCY
  SLEEP_SCORE

  // Activity
  STEPS
  ACTIVE_CALORIES
  TOTAL_CALORIES
  EXERCISE_MINUTES
  STANDING_HOURS

  // Recovery & Strain
  RECOVERY_SCORE
  STRAIN_SCORE
  READINESS_SCORE

  // Body Composition
  BODY_FAT_PERCENTAGE
  MUSCLE_MASS
  BONE_MASS
  WATER_PERCENTAGE

  // Other
  SKIN_TEMPERATURE
  BLOOD_GLUCOSE
  STRESS_LEVEL
}

enum ActivityType {
  // Cardio
  RUNNING
  CYCLING
  SWIMMING
  WALKING
  HIKING
  ROWING
  ELLIPTICAL

  // Strength
  WEIGHT_TRAINING
  BODYWEIGHT
  CROSSFIT
  POWERLIFTING

  // Sports
  BASKETBALL
  SOCCER
  TENNIS
  GOLF

  // Other
  YOGA
  PILATES
  STRETCHING
  MARTIAL_ARTS
  DANCE
  OTHER
}

enum ActivityIntensity {
  LOW
  MODERATE
  HIGH
  MAXIMUM
}

enum MLFeatureCategory {
  NUTRITION_DAILY
  NUTRITION_WEEKLY
  NUTRITION_TEMPORAL
  ACTIVITY_DAILY
  ACTIVITY_WEEKLY
  HEALTH_DAILY
  HEALTH_WEEKLY
  COMBINED_FEATURES
}

enum MLInsightType {
  CORRELATION
  PREDICTION
  ANOMALY
  RECOMMENDATION
  GOAL_PROGRESS
  PATTERN_DETECTED
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// ADMIN PANEL MODELS
// ============================================================================

// Admin user roles for RBAC
enum AdminRole {
  SUPER_ADMIN  // Full access, can manage other admins
  SUPPORT      // User/subscription management, no settings
  ANALYST      // Read-only analytics access
  VIEWER       // Read-only all access
}

// Feature flag value types
enum FeatureFlagType {
  BOOLEAN
  STRING
  NUMBER
  JSON
}

// Admin User - Separate from app users for security
model AdminUser {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String
  name          String

  // Role-based access control
  role          AdminRole  @default(SUPPORT)

  // MFA (TOTP) configuration
  mfaSecret     String?    // TOTP secret key (encrypted)
  mfaEnabled    Boolean    @default(false)

  // Account status
  isActive      Boolean    @default(true)
  lastLoginAt   DateTime?
  lastLoginIp   String?

  // Audit
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  auditLogs     AdminAuditLog[]

  @@index([email])
  @@index([role, isActive])
}

// Admin Audit Log - Immutable record of all admin actions
model AdminAuditLog {
  id            String     @id @default(cuid())
  adminUserId   String
  adminUser     AdminUser  @relation(fields: [adminUserId], references: [id])

  // Action details
  action        String     // e.g., "USER_LOOKUP", "SUBSCRIPTION_GRANT", "USER_DELETE"
  targetType    String?    // e.g., "User", "Subscription", "Webhook"
  targetId      String?    // ID of affected record

  // Additional context (JSON for flexibility)
  details       Json?      // {reason: "Customer request", previousValue: {...}}

  // Request metadata
  ipAddress     String
  userAgent     String?

  // Timestamp (immutable - no updatedAt)
  createdAt     DateTime   @default(now())

  @@index([adminUserId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// App Store Webhook Events - Tracks StoreKit 2 server notifications
model AppStoreWebhookEvent {
  id                    String              @id @default(cuid())

  // Notification details
  notificationType      String              // SUBSCRIBED, DID_RENEW, DID_CHANGE_RENEWAL_STATUS, etc.
  subtype               String?             // AUTO_RENEW_DISABLED, UPGRADE, DOWNGRADE, etc.

  // Apple identifiers
  originalTransactionId String?             // Links to subscription
  transactionId         String?             // Current transaction
  bundleId              String?             // App bundle identifier

  // Full payload for debugging/replay
  payload               Json                // Complete JWS decoded payload

  // Processing status
  status                WebhookEventStatus  @default(PENDING)
  errorMessage          String?             // Error details if failed
  retryCount            Int                 @default(0)
  lastRetryAt           DateTime?

  // Related user (if we can identify them)
  userId                String?

  // Timestamps
  receivedAt            DateTime            @default(now())
  processedAt           DateTime?
  createdAt             DateTime            @default(now())

  @@index([notificationType])
  @@index([originalTransactionId])
  @@index([userId])
  @@index([status])
  @@index([receivedAt])
}

enum WebhookEventStatus {
  PENDING
  SUCCESS
  FAILED
}

// Feature Flags - For gradual rollouts and A/B testing
model FeatureFlag {
  id            String          @id @default(cuid())
  key           String          @unique  // e.g., "new_paywall_design"
  name          String                   // Human-readable name
  description   String?                  // Explanation of the flag

  // Value configuration
  type          FeatureFlagType @default(BOOLEAN)
  value         Json            // Default value: true/false, "string", 123, or {...}

  // Status
  isEnabled     Boolean         @default(false)

  // Targeting rules (JSON for flexibility)
  // e.g., {userId: ["id1", "id2"], subscriptionTier: "PRO", percentage: 50}
  targeting     Json?

  // Audit
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([key])
  @@index([isEnabled])
}

// ============================================================================
// PUSH NOTIFICATIONS MODELS
// ============================================================================

// DeviceToken - Stores push notification device tokens
model DeviceToken {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token details
  token         String          // APNs/FCM token
  platform      DevicePlatform

  // Expo push token (if using Expo)
  expoPushToken String?

  // Status
  isActive      Boolean         @default(true)
  lastActiveAt  DateTime        @default(now())

  // Device info (optional, for analytics)
  deviceModel   String?         // e.g., "iPhone 15 Pro", "Pixel 8"
  osVersion     String?         // e.g., "iOS 17.2", "Android 14"
  appVersion    String?         // e.g., "1.2.3"

  // Audit
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([userId, token, platform])
  @@index([userId, isActive])
  @@index([token])
  @@index([userId, platform])
}

// NotificationPreference - User notification settings
model NotificationPreference {
  id                  String    @id @default(cuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Master toggle
  enabled             Boolean   @default(true)

  // Category toggles (stored as array of enabled categories)
  enabledCategories   NotificationCategory[]

  // Quiet hours (24h format, stored as HH:mm strings)
  quietHoursEnabled   Boolean   @default(false)
  quietHoursStart     String?   // e.g., "22:00"
  quietHoursEnd       String?   // e.g., "08:00"

  // Meal reminder times (JSON for flexibility)
  // { breakfast: "08:00", lunch: "12:30", dinner: "18:30", snack: null }
  mealReminderTimes   Json?

  // Additional settings (JSON for future extensibility)
  // { frequency: "normal", sound: "default", vibration: true }
  settings            Json?

  // Audit
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([userId])
}

// NotificationLog - Record of sent notifications
model NotificationLog {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification content
  category          NotificationCategory
  title             String
  body              String
  data              Json?               // Custom payload data

  // Delivery details
  platform          DevicePlatform
  deviceToken       String?             // Token used for sending
  expoPushToken     String?             // Expo token if used

  // iOS-specific
  interruptionLevel String?             // passive, active, timeSensitive, critical
  threadId          String?             // For notification grouping
  relevanceScore    Float?              // 0.0 to 1.0

  // Campaign reference (if sent via campaign)
  campaignId        String?
  campaign          NotificationCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  // Status tracking
  sentAt            DateTime            @default(now())
  deliveredAt       DateTime?
  openedAt          DateTime?
  actionTaken       String?             // Which action button was tapped

  // Error tracking
  error             String?             // Error message if send failed
  status            NotificationStatus  @default(SENT)

  // Audit
  createdAt         DateTime            @default(now())

  @@index([userId, sentAt])
  @@index([category])
  @@index([campaignId])
  @@index([status])
  @@index([userId, category, sentAt])
}

// NotificationCampaign - Bulk notification campaigns
model NotificationCampaign {
  id                String            @id @default(cuid())

  // Campaign details
  title             String            // Internal name for admin
  description       String?           // Internal description

  // Notification content
  notificationTitle String            // Displayed to users
  notificationBody  String            // Displayed to users
  category          NotificationCategory
  data              Json?             // Custom payload data

  // Targeting
  targetSegment     Json              // Segmentation rules (JSON)
  // { activityLevel: "active", goals: ["weight_loss"], subscriptionTier: "PRO" }
  estimatedRecipients Int?            // Calculated recipient count

  // A/B Testing (optional)
  isAbTest          Boolean           @default(false)
  variants          Json?             // { A: { title, body }, B: { title, body } }
  winningVariant    String?           // "A" or "B" after test completes

  // Scheduling
  scheduledAt       DateTime?         // When to send (null = immediately)
  sentAt            DateTime?         // When actually sent

  // Status
  status            CampaignStatus    @default(DRAFT)

  // Analytics
  deliveryCount     Int               @default(0)
  openCount         Int               @default(0)
  actionCount       Int               @default(0) // Action button taps
  failureCount      Int               @default(0)

  // Relations
  notificationLogs  NotificationLog[]

  // Audit (created by admin)
  createdByAdminId  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([category])
  @@index([createdByAdminId])
}

// NotificationTemplate - Reusable notification templates
model NotificationTemplate {
  id            String              @id @default(cuid())

  // Template details
  name          String              // Internal name
  description   String?             // Description of when to use

  // Content
  category      NotificationCategory
  title         String              // Supports variables: {{userName}}, {{goalProgress}}, etc.
  body          String              // Supports variables
  data          Json?               // Default custom payload

  // Variable definitions
  // ["userName", "goalProgress", "streakDays"]
  variables     String[]

  // Usage tracking
  usageCount    Int                 @default(0)

  // Locale support (for future i18n)
  locale        String              @default("en")

  // Audit
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([name, locale])
  @@index([category])
  @@index([locale])
}

// ============================================================================
// NOTIFICATION ENUMS
// ============================================================================

enum DevicePlatform {
  IOS
  ANDROID
}

enum NotificationCategory {
  MEAL_REMINDER
  GOAL_PROGRESS
  HEALTH_INSIGHT
  SUPPLEMENT_REMINDER
  STREAK_ALERT
  WEEKLY_SUMMARY
  MARKETING           // Requires separate consent
  SYSTEM              // Account alerts, security, etc.
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  FAILED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  CANCELLED
  FAILED
}

// ============================================================================
// IN-APP PURCHASE / SUBSCRIPTION MODELS
// ============================================================================

// Subscription Status for Apple IAP
enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  IN_GRACE_PERIOD
  IN_BILLING_RETRY
  REVOKED
  REFUNDED
}

// Environment (sandbox or production)
enum SubscriptionEnvironment {
  SANDBOX
  PRODUCTION
}

// Subscription - Main subscription record for IAP
model Subscription {
  id                    String                 @id @default(cuid())
  userId                String                 @unique
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Apple IAP identifiers
  productId             String                 // e.g., "nutri.pro.monthly", "nutri.pro.yearly"
  originalTransactionId String                 @unique // Apple's original transaction ID

  // Subscription status
  status                SubscriptionStatus     @default(ACTIVE)
  expiresAt             DateTime               // When the subscription expires
  cancelledAt           DateTime?              // When user cancelled (still active until expiresAt)

  // Trial and offer periods
  isTrialPeriod         Boolean                @default(false)
  isIntroOfferPeriod    Boolean                @default(false)
  trialEndsAt           DateTime?              // When trial period ends

  // Renewal info
  autoRenewEnabled      Boolean                @default(true)
  autoRenewProductId    String?                // Product they will renew to (for upgrades/downgrades)
  gracePeriodExpiresAt  DateTime?              // Grace period expiration
  billingRetryExpiresAt DateTime?              // Billing retry period expiration

  // Pricing info
  priceLocale           String?                // e.g., "en_US"
  priceCurrency         String?                // e.g., "USD"
  priceAmount           Decimal?               @db.Decimal(10, 2) // e.g., 9.99

  // Environment
  environment           SubscriptionEnvironment @default(PRODUCTION)

  // Relations
  events                SubscriptionEvent[]

  // Audit
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  @@index([userId])
  @@index([originalTransactionId])
  @@index([status, expiresAt])
  @@index([productId])
}

// SubscriptionEvent - Audit log for subscription changes
model SubscriptionEvent {
  id                    String       @id @default(cuid())
  subscriptionId        String
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Notification details
  notificationType      String       // SUBSCRIBED, DID_RENEW, EXPIRED, REFUND, etc.
  subtype               String?      // AUTO_RENEW_DISABLED, UPGRADE, etc.

  // Transaction identifiers
  transactionId         String?      // Current transaction ID
  originalTransactionId String       // Original transaction ID

  // Notification UUID for idempotency
  notificationUUID      String?      @unique

  // Full event data (for debugging and auditing)
  eventData             Json?

  // Processing metadata
  processedAt           DateTime     @default(now())

  // Audit
  createdAt             DateTime     @default(now())

  @@index([subscriptionId])
  @@index([notificationType])
  @@index([originalTransactionId])
  @@index([createdAt])
}

// ============================================================================
// QUICK ADD & FAVORITES SYSTEM
// ============================================================================

/**
 * FavoriteMeal - User's saved favorite meals for quick logging
 * Contains nutritional data snapshot at time of saving
 */
model FavoriteMeal {
  id              String    @id @default(cuid())
  userId          String

  // Meal information (snapshot)
  name            String
  mealType        String?   // breakfast, lunch, dinner, snack (optional default)
  calories        Float
  protein         Float
  carbs           Float
  fat             Float
  fiber           Float?
  sugar           Float?
  sodium          Float?
  servingSize     String?

  // Source tracking
  sourceType      FavoriteSourceType @default(CUSTOM)
  sourceMealId    String?   // Original meal ID if copied from a meal
  fdcId           Int?      // USDA FDC ID if from food database
  barcode         String?   // Barcode if scanned

  // User customization
  customName      String?   // User's custom name for this favorite
  notes           String?
  imageUrl        String?

  // Usage tracking
  usageCount      Int       @default(0)
  lastUsedAt      DateTime?

  // Ordering
  sortOrder       Int       @default(0) // For manual reordering

  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, usageCount])
  @@index([userId, lastUsedAt])
  @@index([userId, sortOrder])
}

/**
 * MealTemplate - Reusable meal templates with multiple items
 * Useful for recurring meals like "Breakfast Combo" with multiple foods
 */
model MealTemplate {
  id              String    @id @default(cuid())
  userId          String

  // Template info
  name            String
  description     String?
  mealType        String?   // Default meal type
  imageUrl        String?

  // Total nutritional values (calculated from items)
  totalCalories   Float     @default(0)
  totalProtein    Float     @default(0)
  totalCarbs      Float     @default(0)
  totalFat        Float     @default(0)
  totalFiber      Float?

  // Template items (JSON for flexibility)
  // Array of: [{name, calories, protein, carbs, fat, fiber?, servingSize?, quantity?}]
  items           Json

  // Usage tracking
  usageCount      Int       @default(0)
  lastUsedAt      DateTime?

  // Ordering
  sortOrder       Int       @default(0)

  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, usageCount])
  @@index([userId, lastUsedAt])
}

/**
 * QuickAddPreset - User's custom quick-add buttons
 * For frequently logged items like water amounts, snacks, etc.
 */
model QuickAddPreset {
  id              String    @id @default(cuid())
  userId          String

  // Preset info
  name            String    // e.g., "Morning Coffee", "Protein Shake"
  icon            String?   // Icon identifier (e.g., "coffee", "protein")
  color           String?   // Hex color for UI

  // What this preset adds
  presetType      QuickAddPresetType

  // For MEAL/FOOD type
  mealName        String?
  mealType        String?
  calories        Float?
  protein         Float?
  carbs           Float?
  fat             Float?
  fiber           Float?
  servingSize     String?

  // For WATER type
  waterAmount     Int?      // in ml

  // Usage tracking
  usageCount      Int       @default(0)
  lastUsedAt      DateTime?

  // Ordering
  sortOrder       Int       @default(0)

  // Active status
  isActive        Boolean   @default(true)

  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, isActive, sortOrder])
  @@index([userId, usageCount])
}

/**
 * RecentFood - Cache of recently logged foods for quick access
 * Auto-populated when meals are logged, pruned to keep recent items
 */
model RecentFood {
  id              String    @id @default(cuid())
  userId          String

  // Food info
  name            String
  calories        Float
  protein         Float
  carbs           Float
  fat             Float
  fiber           Float?
  sugar           Float?
  servingSize     String?

  // Source tracking
  fdcId           Int?
  barcode         String?

  // Recency tracking
  logCount        Int       @default(1)  // How many times logged
  lastLoggedAt    DateTime  @default(now())

  // Audit
  createdAt       DateTime  @default(now())

  @@unique([userId, name])  // One entry per food name per user
  @@index([userId, lastLoggedAt])
  @@index([userId, logCount])
}

// Enum for favorite source type
enum FavoriteSourceType {
  CUSTOM      // User created
  MEAL        // Copied from a logged meal
  DATABASE    // From food database (USDA, OpenFoodFacts)
  BARCODE     // From barcode scan
}

// Enum for quick add preset types
enum QuickAddPresetType {
  MEAL        // Adds a meal entry
  WATER       // Adds water intake
  SUPPLEMENT  // Adds supplement log
}

// ============================================================================
// CONTINUOUS GLUCOSE MONITOR (CGM) INTEGRATION
// ============================================================================

/**
 * CGM data source providers
 * Tracks the origin of glucose readings for data provenance
 */
enum GlucoseSource {
  DEXCOM       // Dexcom G6/G7 CGM devices via Dexcom API
  LIBRE        // Abbott FreeStyle Libre via LibreView API
  LEVELS       // Levels Health API (enriched CGM data)
  MANUAL       // Manually entered glucose readings
}

/**
 * CGM trend arrow direction
 * Indicates the direction and rate of glucose change
 */
enum GlucoseTrend {
  RISING_RAPIDLY      // ↑↑ Rising more than 3 mg/dL per minute
  RISING              // ↑ Rising between 2-3 mg/dL per minute
  RISING_SLIGHTLY     // ↗ Rising between 1-2 mg/dL per minute
  STABLE              // → Stable, changing less than 1 mg/dL per minute
  FALLING_SLIGHTLY    // ↘ Falling between 1-2 mg/dL per minute
  FALLING             // ↓ Falling between 2-3 mg/dL per minute
  FALLING_RAPIDLY     // ↓↓ Falling more than 3 mg/dL per minute
  NOT_AVAILABLE       // Unknown or unavailable trend
}

/**
 * GlucoseReading - Individual glucose measurements from CGM devices
 * Stores raw glucose values with 5-minute intervals (typical CGM frequency)
 */
model GlucoseReading {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Glucose value
  value           Float         // Glucose value in mg/dL
  unit            String        @default("mg/dL")  // mg/dL or mmol/L

  // Source and provenance
  source          GlucoseSource
  sourceId        String?       // Original reading ID from CGM provider

  // Trend information
  trendArrow      GlucoseTrend?
  trendRate       Float?        // Rate of change in mg/dL per minute

  // Timing
  recordedAt      DateTime      // When the reading was taken

  // Additional metadata
  metadata        Json?         // {quality: "good", transmitterId: "...", sessionId: "..."}

  // Audit
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Indexes for efficient queries
  @@index([userId, recordedAt])
  @@index([userId, source, recordedAt])
  @@unique([userId, source, recordedAt]) // Prevent duplicate readings
}

/**
 * MealGlucoseResponse - Analyzed glucose response metrics for each meal
 * Links meals to their postprandial glucose curves and metabolic scores
 */
model MealGlucoseResponse {
  id                  String    @id @default(cuid())
  mealId              String    @unique
  meal                Meal      @relation(fields: [mealId], references: [id], onDelete: Cascade)

  // Baseline measurement (pre-meal glucose)
  baselineGlucose     Float     // Average glucose 30 min before meal (mg/dL)
  baselineTime        DateTime  // When baseline was measured

  // Peak response
  peakGlucose         Float     // Maximum glucose after meal (mg/dL)
  peakTime            Int       // Minutes after meal to reach peak
  glucoseRise         Float     // Difference: peak - baseline (mg/dL)

  // Recovery metrics
  returnToBaseline    Int?      // Minutes to return within 10% of baseline
  twoHourGlucose      Float?    // Glucose value 2 hours after meal

  // Integrated metrics
  areaUnderCurve      Float     // AUC above baseline (mg/dL * minutes)
  glucoseScore        Float     // Metabolic response score (0-100, higher = better)

  // Analysis quality
  readingCount        Int       // Number of glucose readings in analysis window
  confidence          Float     // Confidence score (0-1) based on data quality

  // Timing
  analyzedAt          DateTime  @default(now())
  windowStart         DateTime  // Start of analysis window
  windowEnd           DateTime  // End of analysis window

  // Audit
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([mealId])
}

/**
 * CGMConnection - OAuth credentials for CGM platform integrations
 * Stores encrypted tokens for secure API access to CGM providers
 */
model CGMConnection {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider info
  provider        GlucoseSource

  // OAuth tokens (should be encrypted at application level)
  accessToken     String        @db.Text  // Encrypted access token
  refreshToken    String?       @db.Text  // Encrypted refresh token
  tokenType       String        @default("Bearer")
  expiresAt       DateTime      // Token expiration time
  scope           String?       // OAuth scopes granted

  // Sync status
  lastSyncAt      DateTime?     // Last successful data sync
  lastSyncStatus  String?       // "success", "error", "partial"
  lastSyncError   String?       // Error message if sync failed

  // Connection status
  isActive        Boolean       @default(true)
  connectedAt     DateTime      @default(now())
  disconnectedAt  DateTime?     // When user disconnected

  // Provider-specific data
  externalUserId  String?       // User ID from the CGM provider
  metadata        Json?         // Provider-specific configuration

  // Audit
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // One connection per provider per user
  @@unique([userId, provider])
  @@index([userId, isActive])
  @@index([provider, isActive])
}

// ============================================================================
// EMAIL MARKETING SYSTEM
// ============================================================================

/**
 * EmailTemplate - Reusable email templates with MJML content
 * Supports both transactional and marketing email types
 */
model EmailTemplate {
  id              String          @id @default(cuid())

  // Template identification
  name            String          // Human-readable name
  slug            String          @unique  // Unique identifier for API usage
  category        EmailCategory   // TRANSACTIONAL or MARKETING

  // Content
  subject         String          // Email subject (supports variables)
  mjmlContent     String          @db.Text  // MJML source content
  htmlContent     String?         @db.Text  // Compiled HTML (cached)
  plainTextContent String?        @db.Text  // Plain text version

  // Variable definitions
  variables       Json?           // Array of variable names: ["userName", "goalProgress"]

  // Versioning
  version         Int             @default(1)
  isActive        Boolean         @default(true)

  // Audit
  createdBy       String?         // AdminUser ID
  updatedBy       String?         // AdminUser ID
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  campaigns       EmailCampaign[]

  @@index([slug])
  @@index([category, isActive])
}

/**
 * EmailCampaign - Marketing email campaigns with targeting and scheduling
 */
model EmailCampaign {
  id                  String              @id @default(cuid())

  // Campaign details
  name                String
  description         String?

  // Template
  templateId          String
  template            EmailTemplate       @relation(fields: [templateId], references: [id])

  // Targeting
  segmentCriteria     Json?               // {activityLevel: "active", subscriptionTier: "PRO", ...}
  estimatedAudience   Int?                // Calculated audience size
  actualSent          Int                 @default(0)

  // Scheduling
  scheduledAt         DateTime?           // When to send (null = immediately)
  sentAt              DateTime?           // When actually started sending
  completedAt         DateTime?           // When finished sending

  // Status
  status              EmailCampaignStatus @default(DRAFT)

  // A/B Testing
  abTestConfig        Json?               // {subjectVariants: ["A", "B"], splitPercentage: 50}
  winningVariant      String?             // "A" or "B"

  // Analytics (denormalized for fast access)
  deliveredCount      Int                 @default(0)
  openedCount         Int                 @default(0)
  clickedCount        Int                 @default(0)
  bouncedCount        Int                 @default(0)
  unsubscribedCount   Int                 @default(0)
  complainedCount     Int                 @default(0)

  // Audit
  createdBy           String?             // AdminUser ID
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  emailLogs           EmailLog[]

  @@index([status, scheduledAt])
  @@index([templateId])
}

/**
 * EmailLog - Record of individual emails sent to users
 * Tracks delivery, opens, clicks, bounces, and unsubscribes
 */
model EmailLog {
  id                  String          @id @default(cuid())
  userId              String
  email               String          // Email address sent to

  // Email reference
  templateSlug        String          // Template used
  campaignId          String?         // Campaign (null for transactional)
  campaign            EmailCampaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  sequenceEnrollmentId String?        // Sequence enrollment (null if not from sequence)

  // Status tracking
  status              EmailLogStatus  @default(QUEUED)

  // Provider info
  providerMessageId   String?         // Resend/SendGrid message ID

  // Timestamps for delivery funnel
  queuedAt            DateTime        @default(now())
  sentAt              DateTime?
  deliveredAt         DateTime?
  openedAt            DateTime?
  clickedAt           DateTime?
  bouncedAt           DateTime?
  unsubscribedAt      DateTime?
  complainedAt        DateTime?

  // Open tracking
  isAppleProxyOpen    Boolean         @default(false)  // Apple Mail Privacy Protection
  openCount           Int             @default(0)      // Total opens (for re-opens)

  // Click tracking
  clickData           Json?           // [{url: "...", clickedAt: "..."}]

  // Bounce details
  bounceType          String?         // "hard" or "soft"
  bounceReason        String?         // Error message from provider

  // Metadata
  metadata            Json?           // Additional tracking data

  // Audit
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([userId, createdAt])
  @@index([campaignId, status])
  @@index([templateSlug])
  @@index([status])
  @@index([email])
}

/**
 * EmailPreference - User email subscription preferences
 * Tracks opt-in status, categories, and frequency settings
 */
model EmailPreference {
  id                      String          @id @default(cuid())
  userId                  String          @unique
  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Category preferences (JSON for flexibility)
  // {weekly_reports: true, health_insights: true, tips: true, features: true, promotions: false}
  categories              Json?

  // Frequency
  frequency               EmailFrequency  @default(REALTIME)

  // Marketing consent
  marketingOptIn          Boolean         @default(false)
  doubleOptInConfirmedAt  DateTime?       // When double opt-in was confirmed

  // Unsubscribe tracking
  globalUnsubscribedAt    DateTime?       // When user unsubscribed from all marketing

  // One-click unsubscribe token
  unsubscribeToken        String          @unique @default(cuid())

  // Suppression (for bounces/complaints)
  isSuppressed            Boolean         @default(false)
  suppressionReason       String?         // "hard_bounce", "complaint", "manual"
  suppressedAt            DateTime?

  // Engagement score (calculated periodically)
  engagementScore         Float?          // 0-100 based on opens/clicks
  lastEngagementAt        DateTime?       // Last open or click

  // Audit
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  @@index([userId])
  @@index([unsubscribeToken])
  @@index([isSuppressed])
}

/**
 * EmailSequence - Automated email sequences (drip campaigns)
 * Triggered by events like signup, first meal, inactivity, etc.
 */
model EmailSequence {
  id                  String                  @id @default(cuid())

  // Sequence details
  name                String
  description         String?

  // Trigger
  triggerEvent        EmailSequenceTrigger

  // Status
  isActive            Boolean                 @default(false)

  // Steps (JSON array of sequence steps)
  // [{stepNumber: 1, delayHours: 0, templateId: "...", condition: {...}}]
  steps               Json

  // Entry/Exit criteria
  enrollmentCriteria  Json?                   // Who can enter this sequence
  exitCriteria        Json?                   // When to auto-exit

  // Analytics (denormalized)
  totalEnrollments    Int                     @default(0)
  activeEnrollments   Int                     @default(0)
  completedEnrollments Int                    @default(0)
  exitedEnrollments   Int                     @default(0)

  // Audit
  createdBy           String?                 // AdminUser ID
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  // Relations
  enrollments         EmailSequenceEnrollment[]

  @@index([triggerEvent, isActive])
}

/**
 * EmailSequenceEnrollment - User enrollment in an email sequence
 * Tracks progress through the sequence steps
 */
model EmailSequenceEnrollment {
  id                  String                  @id @default(cuid())
  userId              String
  sequenceId          String
  sequence            EmailSequence           @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Progress
  currentStep         Int                     @default(0)
  status              EmailSequenceStatus     @default(ACTIVE)

  // Timestamps
  startedAt           DateTime                @default(now())
  pausedAt            DateTime?
  completedAt         DateTime?
  exitedAt            DateTime?

  // Next scheduled email
  nextStepScheduledAt DateTime?

  // Exit reason
  exitReason          String?                 // "user_unsubscribed", "goal_achieved", etc.

  // Metadata
  metadata            Json?                   // Tracking data

  // Audit
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  @@unique([userId, sequenceId])  // User can only be enrolled once per sequence
  @@index([userId, status])
  @@index([sequenceId, status])
  @@index([nextStepScheduledAt])
}

// ============================================================================
// EMAIL MARKETING ENUMS
// ============================================================================

enum EmailCategory {
  TRANSACTIONAL       // Always delivered: password reset, receipts, etc.
  MARKETING           // Requires opt-in: newsletters, promotions, etc.
}

enum EmailCampaignStatus {
  DRAFT               // Being created
  SCHEDULED           // Waiting to be sent
  SENDING             // Currently sending
  SENT                // Finished sending (legacy, use COMPLETED)
  COMPLETED           // All emails sent
  CANCELLED           // Cancelled by admin
  FAILED              // Failed to send
}

enum EmailLogStatus {
  QUEUED              // In queue, waiting to be sent
  SENDING             // Being sent to provider
  SENT                // Sent to provider (not yet delivered)
  DELIVERED           // Confirmed delivered
  OPENED              // User opened the email
  CLICKED             // User clicked a link
  BOUNCED             // Failed to deliver
  COMPLAINED          // Marked as spam
  UNSUBSCRIBED        // User unsubscribed via this email
}

enum EmailFrequency {
  REALTIME            // Send immediately as events happen
  DAILY_DIGEST        // Combine into daily summary
  WEEKLY_DIGEST       // Combine into weekly summary
}

enum EmailSequenceTrigger {
  SIGNUP              // New user registration
  FIRST_MEAL          // First meal logged
  GOAL_ACHIEVED       // User achieved a goal
  SUBSCRIPTION_CHANGED // Subscription tier changed
  INACTIVITY_7D       // No activity for 7 days
  INACTIVITY_14D      // No activity for 14 days
  INACTIVITY_30D      // No activity for 30 days
}

enum EmailSequenceStatus {
  ACTIVE              // Currently progressing through sequence
  PAUSED              // Temporarily paused
  COMPLETED           // Finished all steps
  EXITED              // Exited early (unsubscribed, criteria met, etc.)
}

// =============================================================================
// GAMIFICATION MODELS
// =============================================================================

/**
 * UserStreak - Track user's daily activity streaks
 */
model UserStreak {
  id              String    @id @default(cuid())
  userId          String    @unique

  // Current streak
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastActivityDate DateTime? // Last date user logged activity

  // Streak types
  mealStreak      Int       @default(0)   // Days with at least one meal logged
  waterStreak     Int       @default(0)   // Days with water goal met
  exerciseStreak  Int       @default(0)   // Days with exercise logged

  // Last date for each specific streak (to ensure once-per-day increment)
  lastMealDate    DateTime? // Last date a meal was logged
  lastWaterDate   DateTime? // Last date water goal was met
  lastExerciseDate DateTime? // Last date exercise was logged

  // Freeze tokens (streak protection)
  freezeTokens    Int       @default(0)   // Available streak freeze tokens
  freezeUsedAt    DateTime? // Last time a freeze was used

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([currentStreak])
  @@index([longestStreak])
}

/**
 * Achievement - Define available achievements/badges
 */
model Achievement {
  id              String    @id @default(cuid())

  // Achievement info
  name            String    @unique
  title           String    // Display title
  description     String
  icon            String?   // Icon name or URL
  category        AchievementCategory

  // Requirements
  requirement     AchievementRequirement // Type of requirement
  targetValue     Int       // Target value to unlock

  // Rewards
  xpReward        Int       @default(0)
  badgeColor      String?   // Badge display color

  // Tiers (optional)
  tier            AchievementTier @default(BRONZE)
  parentId        String?   // For tiered achievements (e.g., Bronze -> Silver -> Gold)
  parent          Achievement? @relation("AchievementTiers", fields: [parentId], references: [id])
  children        Achievement[] @relation("AchievementTiers")

  // Status
  isActive        Boolean   @default(true)
  isHidden        Boolean   @default(false) // Hidden achievements

  // Relations
  userAchievements UserAchievement[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([category])
  @@index([requirement])
  @@index([isActive])
}

/**
 * UserAchievement - Track user's earned achievements
 */
model UserAchievement {
  id              String    @id @default(cuid())
  userId          String
  achievementId   String
  achievement     Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  // Progress
  currentProgress Int       @default(0)
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?

  // Notification
  hasBeenSeen     Boolean   @default(false) // User has seen the achievement popup

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, achievementId])
  @@index([userId, isCompleted])
  @@index([achievementId])
}

/**
 * UserXP - Track user's XP points and level
 */
model UserXP {
  id              String    @id @default(cuid())
  userId          String    @unique

  // XP tracking
  totalXP         Int       @default(0)
  currentLevel    Int       @default(1)
  xpToNextLevel   Int       @default(100)

  // Weekly/monthly XP (for leaderboards)
  weeklyXP        Int       @default(0)
  monthlyXP       Int       @default(0)
  weekStartDate   DateTime  @default(now())
  monthStartDate  DateTime  @default(now())

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([totalXP])
  @@index([currentLevel])
  @@index([weeklyXP])
  @@index([monthlyXP])
}

/**
 * XPTransaction - Log all XP gains/losses
 */
model XPTransaction {
  id              String    @id @default(cuid())
  userId          String

  amount          Int       // Positive for gain, negative for loss
  source          XPSource  // What action triggered this XP
  description     String?   // Human-readable description

  // Reference to what earned the XP
  referenceId     String?   // ID of meal, achievement, etc.
  referenceType   String?   // "meal", "achievement", "streak", etc.

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

// Achievement Enums
enum AchievementCategory {
  STREAK          // Streak-based achievements
  LOGGING         // Meal/water logging achievements
  NUTRITION       // Nutrition goal achievements
  EXERCISE        // Exercise/activity achievements
  MILESTONE       // Level/XP milestones
  SOCIAL          // Social features (if added)
  SPECIAL         // Special/seasonal achievements
}

enum AchievementRequirement {
  STREAK_DAYS       // Maintain streak for X days
  MEALS_LOGGED      // Log X total meals
  WATER_GOALS_MET   // Meet water goal X times
  CALORIES_UNDER    // Stay under calorie goal X times
  PROTEIN_GOAL      // Meet protein goal X times
  EXERCISES_LOGGED  // Log X exercises
  LEVEL_REACHED     // Reach level X
  XP_EARNED         // Earn X total XP
  WEIGHT_LOGGED     // Log weight X times
  FOODS_SCANNED     // Scan X food items
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum XPSource {
  MEAL_LOGGED       // Logged a meal
  WATER_LOGGED      // Logged water
  WATER_GOAL_MET    // Met daily water goal
  EXERCISE_LOGGED   // Logged exercise
  WEIGHT_LOGGED     // Logged weight
  STREAK_BONUS      // Bonus for maintaining streak
  ACHIEVEMENT       // Earned an achievement
  LEVEL_UP          // Leveled up bonus
  DAILY_BONUS       // Daily login bonus
  CALORIE_GOAL      // Met calorie goal
  MACRO_GOAL        // Met macro goal
}


// =============================================================================
// INTERMITTENT FASTING MODELS
// =============================================================================

/**
 * FastingProtocol - Predefined and custom fasting protocols
 */
model FastingProtocol {
  id              String    @id @default(cuid())
  userId          String?   // Null for system protocols, user ID for custom

  // Protocol info
  name            String    // "16:8", "18:6", "OMAD", etc.
  description     String?
  fastingHours    Int       // Hours of fasting (e.g., 16 for 16:8)
  eatingHours     Int       // Hours of eating window (e.g., 8 for 16:8)

  // For 5:2 style protocols
  isWeeklyProtocol Boolean  @default(false)
  fastingDaysPerWeek Int?   // Days of fasting per week (e.g., 2 for 5:2)
  caloriesOnFastDays Int?   // Calorie limit on fasting days

  // Display
  icon            String?
  color           String?

  // System vs custom
  isSystem        Boolean   @default(false)
  isActive        Boolean   @default(true)

  // Relations
  fastingSessions FastingSession[]
  userSettings    UserFastingSettings[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, name])
  @@index([isSystem, isActive])
  @@index([userId])
}

/**
 * UserFastingSettings - User's fasting preferences
 */
model UserFastingSettings {
  id                  String    @id @default(cuid())
  userId              String    @unique

  // Active protocol
  activeProtocolId    String?
  activeProtocol      FastingProtocol? @relation(fields: [activeProtocolId], references: [id])

  // Preferred schedule
  preferredStartTime  String?   // Time to start fasting (e.g., "20:00")
  preferredEndTime    String?   // Time to end fasting (e.g., "12:00")

  // Notifications
  notifyOnFastStart   Boolean   @default(true)
  notifyOnFastEnd     Boolean   @default(true)
  notifyBeforeEnd     Int?      // Minutes before fast ends to notify

  // Goals
  weeklyFastingGoal   Int?      // Target hours of fasting per week
  monthlyFastingGoal  Int?      // Target hours of fasting per month

  // Display preferences
  showOnDashboard     Boolean   @default(true)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([userId])
}

/**
 * FastingSession - Individual fasting sessions
 */
model FastingSession {
  id              String    @id @default(cuid())
  userId          String

  // Protocol used
  protocolId      String?
  protocol        FastingProtocol? @relation(fields: [protocolId], references: [id])

  // Timing
  startedAt       DateTime  // When fasting started
  plannedEndAt    DateTime  // When fasting is planned to end
  actualEndAt     DateTime? // When fasting actually ended (null if ongoing)

  // Duration
  plannedDuration Int       // Planned duration in minutes
  actualDuration  Int?      // Actual duration in minutes

  // Status
  status          FastingStatus @default(ACTIVE)

  // Notes
  notes           String?
  earlyEndReason  String?   // Why the fast was ended early

  // Metrics during fast
  moodRating      Int?      // 1-5 rating
  energyLevel     Int?      // 1-5 rating
  hungerLevel     Int?      // 1-5 rating

  // Health metrics correlation
  startWeight     Float?    // Weight at start of fast
  endWeight       Float?    // Weight at end of fast

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Checkpoints during the fast
  checkpoints     FastingCheckpoint[]

  @@index([userId, status])
  @@index([userId, startedAt])
  @@index([startedAt])
}

/**
 * FastingCheckpoint - Checkpoints during a fasting session
 */
model FastingCheckpoint {
  id              String    @id @default(cuid())
  sessionId       String
  session         FastingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Timing
  hoursIntoFast   Int       // Hours into the fast

  // Metrics
  moodRating      Int?      // 1-5 rating
  energyLevel     Int?      // 1-5 rating
  hungerLevel     Int?      // 1-5 rating
  notes           String?

  createdAt       DateTime  @default(now())

  @@index([sessionId])
}

/**
 * FastingStreak - Track fasting streaks
 */
model FastingStreak {
  id              String    @id @default(cuid())
  userId          String    @unique

  // Streaks
  currentStreak   Int       @default(0)   // Consecutive successful fasts
  longestStreak   Int       @default(0)
  lastFastDate    DateTime? // Last completed fast date

  // Stats
  totalFasts      Int       @default(0)
  totalMinutes    Int       @default(0)
  successfulFasts Int       @default(0)  // Completed as planned
  brokenFasts     Int       @default(0)  // Ended early

  // Weekly/Monthly stats
  weeklyMinutes   Int       @default(0)
  monthlyMinutes  Int       @default(0)
  weekStartDate   DateTime  @default(now())
  monthStartDate  DateTime  @default(now())

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([currentStreak])
}

// Fasting Enums
enum FastingStatus {
  ACTIVE          // Currently fasting
  COMPLETED       // Completed as planned
  BROKEN          // Ended early
  CANCELLED       // Cancelled before significant progress
}


// ============================================================================
// GDPR COMPLIANCE MODELS
// ============================================================================

/**
 * UserConsent - Track user consent for various data processing purposes
 * Required for GDPR Article 7 (Conditions for consent)
 */
model UserConsent {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Consent purpose
  purpose         ConsentPurpose

  // Consent status
  granted         Boolean       @default(false)
  grantedAt       DateTime?
  revokedAt       DateTime?

  // Consent metadata
  version         String        @default("1.0")  // Privacy policy version
  ipAddress       String?       // IP when consent was given
  userAgent       String?       // Browser/app info when consent was given

  // Source of consent
  source          ConsentSource @default(APP)

  // Audit
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, purpose])
  @@index([userId])
  @@index([purpose, granted])
}

/**
 * DataExportRequest - Track data portability requests (GDPR Article 20)
 * Users can request all their data in a machine-readable format
 */
model DataExportRequest {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Request status
  status          DataRequestStatus   @default(PENDING)

  // Export details
  format          ExportFormat        @default(JSON)
  includeRaw      Boolean             @default(false)  // Include raw ML data

  // Processing info
  requestedAt     DateTime            @default(now())
  processedAt     DateTime?
  completedAt     DateTime?
  expiresAt       DateTime?           // Download link expiration

  // Download details
  downloadUrl     String?             // Secure, temporary download URL
  downloadCount   Int                 @default(0)
  fileSize        Int?                // Size in bytes

  // Error handling
  errorMessage    String?
  retryCount      Int                 @default(0)

  // Request metadata
  ipAddress       String?
  userAgent       String?

  // Audit
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, status])
  @@index([status, requestedAt])
}

/**
 * DataDeletionRequest - Track right to erasure requests (GDPR Article 17)
 * Users can request complete deletion of their data
 */
model DataDeletionRequest {
  id              String              @id @default(cuid())
  userId          String?             // Nullable for SetNull to work when user is deleted
  user            User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  // User email for verification after user is deleted
  userEmail       String

  // Request status
  status          DataRequestStatus   @default(PENDING)

  // Deletion scope
  deletionType    DeletionType        @default(FULL)

  // Verification
  verifiedAt      DateTime?           // Email verification timestamp
  verificationCode String?            // Secure verification code

  // Processing info
  requestedAt     DateTime            @default(now())
  scheduledAt     DateTime?           // When deletion will occur (grace period)
  processedAt     DateTime?
  completedAt     DateTime?

  // Cancellation
  cancelledAt     DateTime?
  cancellationReason String?

  // What was deleted (for audit trail after deletion)
  deletionSummary Json?               // {meals: 150, healthMetrics: 500, ...}

  // Error handling
  errorMessage    String?
  retryCount      Int                 @default(0)

  // Request metadata
  ipAddress       String?
  userAgent       String?
  reason          String?             // User-provided reason

  // Audit
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, status])
  @@index([status, scheduledAt])
  @@index([userEmail])
}

/**
 * PrivacySettings - User privacy preferences
 * Centralized privacy controls for the user
 */
model PrivacySettings {
  id                    String    @id @default(cuid())
  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Data retention preferences
  dataRetentionDays     Int       @default(730)  // Default 2 years
  autoDeleteOldData     Boolean   @default(false)

  // Analytics & tracking
  allowAnalytics        Boolean   @default(true)
  allowCrashReporting   Boolean   @default(true)
  allowPerformanceMonitoring Boolean @default(true)

  // Data sharing
  shareAnonymousData    Boolean   @default(false)  // For research
  shareWithPartners     Boolean   @default(false)

  // Communication preferences
  marketingEmails       Boolean   @default(false)
  productUpdates        Boolean   @default(true)
  securityAlerts        Boolean   @default(true)  // Cannot be disabled

  // Data visibility
  profileVisibility     ProfileVisibility @default(PRIVATE)
  showOnLeaderboard     Boolean   @default(false)

  // Third-party integrations consent
  healthKitDataSharing  Boolean   @default(false)

  // Last privacy policy acceptance
  privacyPolicyVersion  String?
  privacyPolicyAcceptedAt DateTime?
  termsVersion          String?
  termsAcceptedAt       DateTime?

  // Audit
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

/**
 * AuditLog - Immutable record of data access and changes
 * Required for GDPR accountability (Article 5)
 */
model DataAccessLog {
  id              String        @id @default(cuid())
  userId          String?       // May be null if user is deleted

  // Action details
  action          DataAccessAction
  resource        String        // e.g., "meals", "health_metrics", "user_profile"
  resourceId      String?       // Specific record ID if applicable

  // Context
  accessedBy      String?       // "user", "admin", "system", "third_party"
  accessorId      String?       // ID of the accessor

  // Request metadata
  ipAddress       String?
  userAgent       String?

  // Additional context
  metadata        Json?         // {reason: "data_export", admin_id: "..."}

  // Timestamp (immutable)
  accessedAt      DateTime      @default(now())

  @@index([userId, accessedAt])
  @@index([action, accessedAt])
  @@index([resource, accessedAt])
}

// ============================================================================
// GDPR ENUMS
// ============================================================================

enum ConsentPurpose {
  ESSENTIAL           // Essential for service operation (cannot revoke)
  ANALYTICS           // Usage analytics
  MARKETING           // Marketing communications
  RESEARCH            // Anonymous data for research
  THIRD_PARTY         // Third-party integrations
  PERSONALIZATION     // Personalized recommendations
  HEALTH_DATA_SHARING // HealthKit/Health Connect data
}

enum ConsentSource {
  APP                 // Mobile app
  WEB                 // Web interface
  EMAIL               // Email link
  ADMIN               // Admin action
}

enum DataRequestStatus {
  PENDING             // Request received
  PROCESSING          // Currently being processed
  COMPLETED           // Successfully completed
  FAILED              // Failed to process
  CANCELLED           // Cancelled by user
  EXPIRED             // Download link expired (for exports)
}

enum ExportFormat {
  JSON                // Machine-readable JSON
  CSV                 // Spreadsheet-compatible
  PDF                 // Human-readable PDF report
}

enum DeletionType {
  FULL                // Delete all user data
  PARTIAL             // Delete specific data categories
  ANONYMIZE           // Keep data but remove PII
}

enum ProfileVisibility {
  PRIVATE             // Only visible to user
  FRIENDS             // Visible to connected users
  PUBLIC              // Publicly visible
}

enum DataAccessAction {
  VIEW                // Data was viewed
  EXPORT              // Data was exported
  MODIFY              // Data was modified
  DELETE              // Data was deleted
  SHARE               // Data was shared
  ADMIN_ACCESS        // Admin accessed data
}

