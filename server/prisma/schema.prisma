// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations and direct access
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Optional for OAuth users (Apple, Google, etc.)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // OAuth providers
  appleId   String?  @unique

  // Account status
  isActive  Boolean  @default(true)  // Can be set to false to disable account

  // Password reset
  resetToken          String?
  resetTokenExpiresAt DateTime?

  // User profile data
  profilePicture  String?  // Base64 data URL for profile picture
  dateOfBirth     DateTime?
  biologicalSex   BiologicalSex?
  goalCalories    Int      @default(2000)
  goalProtein     Float    @default(150)
  goalCarbs       Float    @default(200)
  goalFat         Float    @default(65)
  currentWeight   Float?
  goalWeight      Float?
  height          Float?
  activityLevel   String   @default("moderate") // sedentary, light, moderate, active, veryActive
  primaryGoal     PrimaryGoal?
  dietaryPreferences Json?  // ["vegetarian", "gluten_free", ...]

  // Subscription
  subscriptionTier        SubscriptionTier @default(FREE)
  subscriptionBillingCycle BillingCycle?   // Only set for PRO tier
  subscriptionStartDate   DateTime?        // When the current subscription started
  subscriptionEndDate     DateTime?        // When trial/subscription ends
  subscriptionPrice       Float?           // Price paid for Pro subscription

  meals           Meal[]
  waterIntakes    WaterIntake[]
  weightRecords   WeightRecord[]

  // ML Relations
  healthMetrics   HealthMetric[]
  activities      Activity[]
  mlFeatures      MLFeature[]
  mlPredictions   MLPrediction[]
  mlInsights      MLInsight[]
  mlProfile       UserMLProfile?

  // Supplements
  supplements     Supplement[]
  supplementLogs  SupplementLog[]

  // Notifications
  deviceTokens            DeviceToken[]
  notificationPreference  NotificationPreference?
  notificationLogs        NotificationLog[]

  // Timezone for notification scheduling
  timezone        String?   // IANA timezone (e.g., "America/New_York", "Europe/London")

  // Onboarding Relations
  onboarding      UserOnboarding?
  healthBackground UserHealthBackground?
  lifestyle       UserLifestyle?
  permissions     UserPermissions?

  @@index([email])
  @@index([appleId])
  @@index([resetToken])
}

model Meal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  mealType    String   // breakfast, lunch, dinner, snack
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  fiber       Float?
  sugar       Float?

  // Fat breakdown (optional)
  saturatedFat       Float?  // grams
  transFat           Float?  // grams
  cholesterol        Float?  // mg

  // Minerals (optional) - values in mg unless noted
  sodium             Float?  // mg
  potassium          Float?  // mg
  calcium            Float?  // mg
  iron               Float?  // mg
  magnesium          Float?  // mg
  zinc               Float?  // mg
  phosphorus         Float?  // mg

  // Vitamins (optional) - values in appropriate units
  vitaminA           Float?  // mcg RAE
  vitaminC           Float?  // mg
  vitaminD           Float?  // mcg
  vitaminE           Float?  // mg
  vitaminK           Float?  // mcg
  vitaminB6          Float?  // mg
  vitaminB12         Float?  // mcg
  folate             Float?  // mcg DFE
  thiamin            Float?  // mg (B1)
  riboflavin         Float?  // mg (B2)
  niacin             Float?  // mg (B3)

  servingSize String?
  notes       String?
  imageUrl    String?

  consumedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, consumedAt])
  @@index([userId, mealType])
}

model WaterIntake {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount    Float    // in ml
  recordedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, recordedAt])
}

model WeightRecord {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  weight    Float    // in kg
  recordedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, recordedAt])
}

// ============================================================================
// ML ENGINE MODELS
// ============================================================================

// Health Metrics - Time series data from wearables (RHR, HRV, sleep, etc.)
model HealthMetric {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamp (UTC, precise to second)
  recordedAt      DateTime

  // Metric type (enum for type safety)
  metricType      HealthMetricType

  // Value (flexible for different units)
  value           Float
  unit            String            // "bpm", "ms", "%", "steps", "kcal", etc.

  // Source (for data provenance)
  source          String            // "apple_health", "fitbit", "garmin", "oura", "whoop", "manual"
  sourceId        String?           // Original ID from source system

  // Metadata (JSON for flexibility)
  metadata        Json?             // {quality: "high", confidence: 0.95, device: "Apple Watch Series 9"}

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, recordedAt])
  @@index([userId, metricType, recordedAt])
  @@unique([userId, metricType, recordedAt, source])
}

// Activity - Exercise and movement data
model Activity {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timing
  startedAt       DateTime
  endedAt         DateTime
  duration        Int               // Duration in minutes

  // Type & Intensity
  activityType    ActivityType
  intensity       ActivityIntensity

  // Metrics
  caloriesBurned  Float?
  averageHeartRate Float?
  maxHeartRate    Float?
  distance        Float?            // In meters
  steps           Int?

  // Source
  source          String            // "apple_health", "strava", "garmin", "manual"
  sourceId        String?

  // Notes
  notes           String?

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, startedAt])
  @@index([userId, activityType, startedAt])
}

// ML Features - Pre-computed features for fast predictions
model MLFeature {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Temporal scope
  date            DateTime          // Date this feature represents (e.g., 2025-01-17)

  // Feature category
  category        MLFeatureCategory

  // Features (JSON for flexibility)
  features        Json              // {protein_7d_avg: 150, carbs_ratio: 0.4, meal_regularity: 0.85}

  // Metadata
  version         String            // "v1.2.3" - for feature engineering versioning

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, date, category])
  @@unique([userId, date, category, version])
}

// ML Predictions - Model outputs and tracking
model MLPrediction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What are we predicting?
  targetMetric    HealthMetricType
  targetDate      DateTime          // When is this prediction for?

  // Prediction
  predictedValue  Float
  confidence      Float             // 0.0 to 1.0
  predictionRange Json              // {lower: 55, upper: 61} for confidence intervals

  // Model metadata
  modelId         String            // "rhr_lstm_v2.1.0"
  modelVersion    String            // "2.1.0"

  // Feature importance (what drove this prediction?)
  featureImportance Json            // {protein_intake: 0.35, sleep_quality: 0.28, ...}

  // Actual outcome (for model evaluation)
  actualValue     Float?
  predictionError Float?            // Calculated after actual value is recorded

  // Audit
  createdAt       DateTime          @default(now())

  @@index([userId, targetDate, targetMetric])
  @@index([userId, modelId, createdAt])
}

// ML Insights - Actionable recommendations for users
model MLInsight {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Insight type
  insightType     MLInsightType
  priority        InsightPriority

  // Content
  title           String            // "Your carb timing affects sleep quality"
  description     String            // Detailed explanation
  recommendation  String            // "Try eating complex carbs earlier in the day"

  // Supporting data
  correlation     Float?            // Correlation coefficient (if applicable)
  confidence      Float             // How confident is the ML model? (0.0 to 1.0)
  dataPoints      Int               // How many data points support this insight?

  // Metadata
  metadata        Json?             // {chart_data: [...], references: [...]}

  // User interaction
  viewed          Boolean           @default(false)
  viewedAt        DateTime?
  dismissed       Boolean           @default(false)
  dismissedAt     DateTime?
  helpful         Boolean?          // User feedback: was this helpful?

  // Audit
  createdAt       DateTime          @default(now())
  expiresAt       DateTime?         // Some insights are time-sensitive

  @@index([userId, createdAt])
  @@index([userId, insightType, priority])
}

// User ML Profile - Per-user model configuration
model UserMLProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Data quality
  totalDataPoints Int      @default(0)
  dataQualityScore Float   @default(0.0) // 0.0 to 1.0

  // Minimum data requirements met?
  hasMinimumNutritionData   Boolean @default(false)
  hasMinimumHealthData      Boolean @default(false)
  hasMinimumActivityData    Boolean @default(false)

  // Model readiness
  modelsAvailable Json     // {rhr_prediction: true, hrv_prediction: false, ...}
  lastTrainingDate DateTime?

  // User preferences
  enablePredictions Boolean @default(true)
  enableInsights    Boolean @default(true)
  insightFrequency  String  @default("daily") // "daily", "weekly", "realtime"

  // Privacy
  shareDataForResearch Boolean @default(false)
  dataRetentionDays    Int     @default(365)

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// FOOD FEEDBACK (ML Learning Loop)
// ============================================================================

// FoodFeedback - User corrections when food classification is wrong
model FoodFeedback {
  id                  String    @id @default(cuid())
  userId              String?
  imageHash           String
  classificationId    String?
  originalPrediction  String
  originalConfidence  Float
  originalCategory    String?
  selectedFdcId       Int
  selectedFoodName    String
  wasCorrect          Boolean
  classificationHints Json?
  userDescription     String?
  status              String    @default("pending") // pending, approved, rejected, applied

  createdAt           DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([originalPrediction])
  @@unique([imageHash, originalPrediction, selectedFdcId])
}

// FoodFeedbackAggregation - Aggregated patterns for model improvement
model FoodFeedbackAggregation {
  id                  String    @id @default(cuid())
  originalPrediction  String
  correctedFood       String
  correctionCount     Int       @default(0)
  avgConfidence       Float     @default(0)
  needsReview         Boolean   @default(false)
  reviewedAt          DateTime?
  firstOccurrence     DateTime
  lastOccurrence      DateTime

  @@unique([originalPrediction, correctedFood])
  @@index([needsReview, reviewedAt])
  @@index([correctionCount])
}

// LearnedPrompt - AI prompts learned from user feedback for CLIP classification
model LearnedPrompt {
  id            Int       @id @default(autoincrement())
  foodKey       String    @db.VarChar(100)
  prompt        String    @db.Text
  source        String    @db.VarChar(50)  // user_description, auto_generated, admin
  timesUsed     Int       @default(0)
  successCount  Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([foodKey, isActive])
}

// ============================================================================
// SUPPLEMENT TRACKING
// ============================================================================

// Supplement - Definition of a supplement the user takes
model Supplement {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name            String              // e.g., "Vitamin D3", "Fish Oil", "Magnesium"
  brand           String?             // Optional brand name

  // Dosage
  dosageAmount    Float               // e.g., 1000, 2, 500
  dosageUnit      String              // e.g., "IU", "mg", "mcg", "g", "capsules", "tablets"

  // Schedule
  frequency       SupplementFrequency @default(DAILY)
  timesPerDay     Int                 @default(1) // How many times per day (for DAILY frequency)
  timeOfDay       SupplementTimeOfDay[] // When to take (morning, afternoon, evening, etc.)
  withFood        Boolean             @default(false) // Should be taken with food

  // Status
  isActive        Boolean             @default(true) // Currently taking this supplement
  startDate       DateTime            @default(now())
  endDate         DateTime?           // When they stopped taking it (null if still active)

  // Additional info
  notes           String?             // Any notes about the supplement
  color           String?             // Optional color for UI display (hex code)

  // Micronutrient content (estimated or from barcode)
  // Vitamins (optional)
  vitaminA        Float?              // mcg RAE
  vitaminC        Float?              // mg
  vitaminD        Float?              // mcg
  vitaminE        Float?              // mg
  vitaminK        Float?              // mcg
  vitaminB6       Float?              // mg
  vitaminB12      Float?              // mcg
  folate          Float?              // mcg DFE
  thiamin         Float?              // mg (B1)
  riboflavin      Float?              // mg (B2)
  niacin          Float?              // mg (B3)

  // Minerals (optional)
  calcium         Float?              // mg
  iron            Float?              // mg
  magnesium       Float?              // mg
  zinc            Float?              // mg
  potassium       Float?              // mg
  sodium          Float?              // mg
  phosphorus      Float?              // mg

  // Special nutrients (optional)
  omega3          Float?              // mg (total EPA + DHA)

  // Relations
  logs            SupplementLog[]

  // Audit
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, isActive])
  @@index([userId, createdAt])
}

// SupplementLog - Record of when a supplement was taken
model SupplementLog {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplementId    String
  supplement      Supplement  @relation(fields: [supplementId], references: [id], onDelete: Cascade)

  // When it was taken
  takenAt         DateTime    @default(now())

  // Optional details
  dosageAmount    Float?      // Override if different from standard dose
  notes           String?     // Any notes for this specific dose
  skipped         Boolean     @default(false) // Marked as intentionally skipped

  // Audit
  createdAt       DateTime    @default(now())

  @@index([userId, takenAt])
  @@index([supplementId, takenAt])
  @@index([userId, supplementId, takenAt])
}

// ============================================================================
// ONBOARDING MODELS
// ============================================================================

// Tracks user onboarding progress and completion
model UserOnboarding {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Progress tracking
  currentStep     Int       @default(1)
  totalSteps      Int       @default(6)
  completedAt     DateTime?
  skippedSteps    Int[]     @default([])

  // Onboarding version (for A/B testing and migrations)
  version         String    @default("1.0")

  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

// User health background: conditions, medications, supplements
model UserHealthBackground {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stored as JSON for flexibility during iteration
  // Structure: [{type: "diabetes", subtype: "type2", diagnosedYear: 2020}]
  chronicConditions Json?

  // Structure: [{name: "metformin", dosage: "500mg", frequency: "daily", category: "diabetes"}]
  medications     Json?

  // Structure: [{name: "vitamin_d", dosage: "2000IU", frequency: "daily", category: "vitamin"}]
  supplements     Json?

  // Structure: ["peanuts", "shellfish", "dairy"]
  allergies       Json?

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// User lifestyle factors that may affect health metrics
model UserLifestyle {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Nicotine
  nicotineUse     NicotineUseLevel?
  nicotineType    String?              // "cigarettes", "vape", "chewing", "other"

  // Alcohol
  alcoholUse      AlcoholUseLevel?

  // Caffeine (cups per day of coffee/tea equivalent)
  caffeineDaily   Int?

  // Sleep patterns
  typicalBedtime  String?              // "22:30" (24h format)
  typicalWakeTime String?              // "06:30" (24h format)
  sleepQuality    Int?                 // 1-10 self-reported

  // Stress
  stressLevel     Int?                 // 1-10 self-reported

  // Work/lifestyle
  workSchedule    String?              // "regular", "shift", "irregular"

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// User permission settings for app features
model UserPermissions {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Push notifications
  notificationsEnabled  Boolean  @default(false)
  notificationTypes     Json?    // ["meal_reminders", "insights", "goals", "weekly_summary"]

  // Health data integrations
  healthKitEnabled      Boolean  @default(false)
  healthKitScopes       Json?    // ["heartRate", "steps", "sleep", "weight", ...]
  healthConnectEnabled  Boolean  @default(false)
  healthConnectScopes   Json?    // Android Health Connect scopes

  // Privacy settings
  shareAnonymousData    Boolean  @default(false)

  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// ENUMS
// ============================================================================

enum SupplementFrequency {
  DAILY
  TWICE_DAILY
  THREE_TIMES_DAILY
  WEEKLY
  EVERY_OTHER_DAY
  AS_NEEDED
}

enum SupplementTimeOfDay {
  MORNING
  AFTERNOON
  EVENING
  BEFORE_BED
  WITH_BREAKFAST
  WITH_LUNCH
  WITH_DINNER
  EMPTY_STOMACH
}

enum SubscriptionTier {
  FREE
  PRO_TRIAL
  PRO
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum BiologicalSex {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum PrimaryGoal {
  WEIGHT_LOSS
  MUSCLE_GAIN
  MAINTENANCE
  GENERAL_HEALTH
  ATHLETIC_PERFORMANCE
  BETTER_SLEEP
  STRESS_REDUCTION
}

enum NicotineUseLevel {
  NONE
  OCCASIONAL
  DAILY
  HEAVY
}

enum AlcoholUseLevel {
  NONE
  OCCASIONAL
  MODERATE
  FREQUENT
}

enum HealthMetricType {
  // Cardiovascular
  RESTING_HEART_RATE
  HEART_RATE_VARIABILITY_SDNN
  HEART_RATE_VARIABILITY_RMSSD
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC

  // Respiratory
  RESPIRATORY_RATE
  OXYGEN_SATURATION
  VO2_MAX

  // Sleep
  SLEEP_DURATION
  DEEP_SLEEP_DURATION
  REM_SLEEP_DURATION
  SLEEP_EFFICIENCY
  SLEEP_SCORE

  // Activity
  STEPS
  ACTIVE_CALORIES
  TOTAL_CALORIES
  EXERCISE_MINUTES
  STANDING_HOURS

  // Recovery & Strain
  RECOVERY_SCORE
  STRAIN_SCORE
  READINESS_SCORE

  // Body Composition
  BODY_FAT_PERCENTAGE
  MUSCLE_MASS
  BONE_MASS
  WATER_PERCENTAGE

  // Other
  SKIN_TEMPERATURE
  BLOOD_GLUCOSE
  STRESS_LEVEL
}

enum ActivityType {
  // Cardio
  RUNNING
  CYCLING
  SWIMMING
  WALKING
  HIKING
  ROWING
  ELLIPTICAL

  // Strength
  WEIGHT_TRAINING
  BODYWEIGHT
  CROSSFIT
  POWERLIFTING

  // Sports
  BASKETBALL
  SOCCER
  TENNIS
  GOLF

  // Other
  YOGA
  PILATES
  STRETCHING
  MARTIAL_ARTS
  DANCE
  OTHER
}

enum ActivityIntensity {
  LOW
  MODERATE
  HIGH
  MAXIMUM
}

enum MLFeatureCategory {
  NUTRITION_DAILY
  NUTRITION_WEEKLY
  NUTRITION_TEMPORAL
  ACTIVITY_DAILY
  ACTIVITY_WEEKLY
  HEALTH_DAILY
  HEALTH_WEEKLY
  COMBINED_FEATURES
}

enum MLInsightType {
  CORRELATION
  PREDICTION
  ANOMALY
  RECOMMENDATION
  GOAL_PROGRESS
  PATTERN_DETECTED
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// ADMIN PANEL MODELS
// ============================================================================

// Admin user roles for RBAC
enum AdminRole {
  SUPER_ADMIN  // Full access, can manage other admins
  SUPPORT      // User/subscription management, no settings
  ANALYST      // Read-only analytics access
  VIEWER       // Read-only all access
}

// Feature flag value types
enum FeatureFlagType {
  BOOLEAN
  STRING
  NUMBER
  JSON
}

// Admin User - Separate from app users for security
model AdminUser {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String
  name          String

  // Role-based access control
  role          AdminRole  @default(SUPPORT)

  // MFA (TOTP) configuration
  mfaSecret     String?    // TOTP secret key (encrypted)
  mfaEnabled    Boolean    @default(false)

  // Account status
  isActive      Boolean    @default(true)
  lastLoginAt   DateTime?
  lastLoginIp   String?

  // Audit
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  auditLogs     AdminAuditLog[]

  @@index([email])
  @@index([role, isActive])
}

// Admin Audit Log - Immutable record of all admin actions
model AdminAuditLog {
  id            String     @id @default(cuid())
  adminUserId   String
  adminUser     AdminUser  @relation(fields: [adminUserId], references: [id])

  // Action details
  action        String     // e.g., "USER_LOOKUP", "SUBSCRIPTION_GRANT", "USER_DELETE"
  targetType    String?    // e.g., "User", "Subscription", "Webhook"
  targetId      String?    // ID of affected record

  // Additional context (JSON for flexibility)
  details       Json?      // {reason: "Customer request", previousValue: {...}}

  // Request metadata
  ipAddress     String
  userAgent     String?

  // Timestamp (immutable - no updatedAt)
  createdAt     DateTime   @default(now())

  @@index([adminUserId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// App Store Webhook Events - Tracks StoreKit 2 server notifications
model AppStoreWebhookEvent {
  id                    String              @id @default(cuid())

  // Notification details
  notificationType      String              // SUBSCRIBED, DID_RENEW, DID_CHANGE_RENEWAL_STATUS, etc.
  subtype               String?             // AUTO_RENEW_DISABLED, UPGRADE, DOWNGRADE, etc.

  // Apple identifiers
  originalTransactionId String?             // Links to subscription
  transactionId         String?             // Current transaction
  bundleId              String?             // App bundle identifier

  // Full payload for debugging/replay
  payload               Json                // Complete JWS decoded payload

  // Processing status
  status                WebhookEventStatus  @default(PENDING)
  errorMessage          String?             // Error details if failed
  retryCount            Int                 @default(0)
  lastRetryAt           DateTime?

  // Related user (if we can identify them)
  userId                String?

  // Timestamps
  receivedAt            DateTime            @default(now())
  processedAt           DateTime?
  createdAt             DateTime            @default(now())

  @@index([notificationType])
  @@index([originalTransactionId])
  @@index([userId])
  @@index([status])
  @@index([receivedAt])
}

enum WebhookEventStatus {
  PENDING
  SUCCESS
  FAILED
}

// Feature Flags - For gradual rollouts and A/B testing
model FeatureFlag {
  id            String          @id @default(cuid())
  key           String          @unique  // e.g., "new_paywall_design"
  name          String                   // Human-readable name
  description   String?                  // Explanation of the flag

  // Value configuration
  type          FeatureFlagType @default(BOOLEAN)
  value         Json            // Default value: true/false, "string", 123, or {...}

  // Status
  isEnabled     Boolean         @default(false)

  // Targeting rules (JSON for flexibility)
  // e.g., {userId: ["id1", "id2"], subscriptionTier: "PRO", percentage: 50}
  targeting     Json?

  // Audit
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([key])
  @@index([isEnabled])
}

// ============================================================================
// PUSH NOTIFICATIONS MODELS
// ============================================================================

// DeviceToken - Stores push notification device tokens
model DeviceToken {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token details
  token         String          // APNs/FCM token
  platform      DevicePlatform

  // Expo push token (if using Expo)
  expoPushToken String?

  // Status
  isActive      Boolean         @default(true)
  lastActiveAt  DateTime        @default(now())

  // Device info (optional, for analytics)
  deviceModel   String?         // e.g., "iPhone 15 Pro", "Pixel 8"
  osVersion     String?         // e.g., "iOS 17.2", "Android 14"
  appVersion    String?         // e.g., "1.2.3"

  // Audit
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([userId, token, platform])
  @@index([userId, isActive])
  @@index([token])
  @@index([userId, platform])
}

// NotificationPreference - User notification settings
model NotificationPreference {
  id                  String    @id @default(cuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Master toggle
  enabled             Boolean   @default(true)

  // Category toggles (stored as array of enabled categories)
  enabledCategories   NotificationCategory[]

  // Quiet hours (24h format, stored as HH:mm strings)
  quietHoursEnabled   Boolean   @default(false)
  quietHoursStart     String?   // e.g., "22:00"
  quietHoursEnd       String?   // e.g., "08:00"

  // Meal reminder times (JSON for flexibility)
  // { breakfast: "08:00", lunch: "12:30", dinner: "18:30", snack: null }
  mealReminderTimes   Json?

  // Additional settings (JSON for future extensibility)
  // { frequency: "normal", sound: "default", vibration: true }
  settings            Json?

  // Audit
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([userId])
}

// NotificationLog - Record of sent notifications
model NotificationLog {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification content
  category          NotificationCategory
  title             String
  body              String
  data              Json?               // Custom payload data

  // Delivery details
  platform          DevicePlatform
  deviceToken       String?             // Token used for sending
  expoPushToken     String?             // Expo token if used

  // iOS-specific
  interruptionLevel String?             // passive, active, timeSensitive, critical
  threadId          String?             // For notification grouping
  relevanceScore    Float?              // 0.0 to 1.0

  // Campaign reference (if sent via campaign)
  campaignId        String?
  campaign          NotificationCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  // Status tracking
  sentAt            DateTime            @default(now())
  deliveredAt       DateTime?
  openedAt          DateTime?
  actionTaken       String?             // Which action button was tapped

  // Error tracking
  error             String?             // Error message if send failed
  status            NotificationStatus  @default(SENT)

  // Audit
  createdAt         DateTime            @default(now())

  @@index([userId, sentAt])
  @@index([category])
  @@index([campaignId])
  @@index([status])
  @@index([userId, category, sentAt])
}

// NotificationCampaign - Bulk notification campaigns
model NotificationCampaign {
  id                String            @id @default(cuid())

  // Campaign details
  title             String            // Internal name for admin
  description       String?           // Internal description

  // Notification content
  notificationTitle String            // Displayed to users
  notificationBody  String            // Displayed to users
  category          NotificationCategory
  data              Json?             // Custom payload data

  // Targeting
  targetSegment     Json              // Segmentation rules (JSON)
  // { activityLevel: "active", goals: ["weight_loss"], subscriptionTier: "PRO" }
  estimatedRecipients Int?            // Calculated recipient count

  // A/B Testing (optional)
  isAbTest          Boolean           @default(false)
  variants          Json?             // { A: { title, body }, B: { title, body } }
  winningVariant    String?           // "A" or "B" after test completes

  // Scheduling
  scheduledAt       DateTime?         // When to send (null = immediately)
  sentAt            DateTime?         // When actually sent

  // Status
  status            CampaignStatus    @default(DRAFT)

  // Analytics
  deliveryCount     Int               @default(0)
  openCount         Int               @default(0)
  actionCount       Int               @default(0) // Action button taps
  failureCount      Int               @default(0)

  // Relations
  notificationLogs  NotificationLog[]

  // Audit (created by admin)
  createdByAdminId  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([category])
  @@index([createdByAdminId])
}

// NotificationTemplate - Reusable notification templates
model NotificationTemplate {
  id            String              @id @default(cuid())

  // Template details
  name          String              // Internal name
  description   String?             // Description of when to use

  // Content
  category      NotificationCategory
  title         String              // Supports variables: {{userName}}, {{goalProgress}}, etc.
  body          String              // Supports variables
  data          Json?               // Default custom payload

  // Variable definitions
  // ["userName", "goalProgress", "streakDays"]
  variables     String[]

  // Usage tracking
  usageCount    Int                 @default(0)

  // Locale support (for future i18n)
  locale        String              @default("en")

  // Audit
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([name, locale])
  @@index([category])
  @@index([locale])
}

// ============================================================================
// NOTIFICATION ENUMS
// ============================================================================

enum DevicePlatform {
  IOS
  ANDROID
}

enum NotificationCategory {
  MEAL_REMINDER
  GOAL_PROGRESS
  HEALTH_INSIGHT
  SUPPLEMENT_REMINDER
  STREAK_ALERT
  WEEKLY_SUMMARY
  MARKETING           // Requires separate consent
  SYSTEM              // Account alerts, security, etc.
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  FAILED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  CANCELLED
  FAILED
}
