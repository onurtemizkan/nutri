// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Optional for OAuth users (Apple, Google, etc.)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // OAuth providers
  appleId   String?  @unique

  // Password reset
  resetToken          String?
  resetTokenExpiresAt DateTime?

  // User profile data
  profilePicture  String?  // Base64 data URL for profile picture
  goalCalories    Int      @default(2000)
  goalProtein     Float    @default(150)
  goalCarbs       Float    @default(200)
  goalFat         Float    @default(65)
  currentWeight   Float?
  goalWeight      Float?
  height          Float?
  activityLevel   String   @default("moderate") // sedentary, light, moderate, active, veryActive

  // Subscription
  subscriptionTier        SubscriptionTier @default(FREE)
  subscriptionBillingCycle BillingCycle?   // Only set for PRO tier
  subscriptionStartDate   DateTime?        // When the current subscription started
  subscriptionEndDate     DateTime?        // When trial/subscription ends
  subscriptionPrice       Float?           // Price paid for Pro subscription

  meals           Meal[]
  waterIntakes    WaterIntake[]
  weightRecords   WeightRecord[]

  // ML Relations
  healthMetrics   HealthMetric[]
  activities      Activity[]
  mlFeatures      MLFeature[]
  mlPredictions   MLPrediction[]
  mlInsights      MLInsight[]
  mlProfile       UserMLProfile?

  // Supplements
  supplements     Supplement[]
  supplementLogs  SupplementLog[]

  @@index([email])
  @@index([appleId])
  @@index([resetToken])
}

model Meal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  mealType    String   // breakfast, lunch, dinner, snack
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  fiber       Float?
  sugar       Float?

  // Fat breakdown (optional)
  saturatedFat       Float?  // grams
  transFat           Float?  // grams
  cholesterol        Float?  // mg

  // Minerals (optional) - values in mg unless noted
  sodium             Float?  // mg
  potassium          Float?  // mg
  calcium            Float?  // mg
  iron               Float?  // mg
  magnesium          Float?  // mg
  zinc               Float?  // mg
  phosphorus         Float?  // mg

  // Vitamins (optional) - values in appropriate units
  vitaminA           Float?  // mcg RAE
  vitaminC           Float?  // mg
  vitaminD           Float?  // mcg
  vitaminE           Float?  // mg
  vitaminK           Float?  // mcg
  vitaminB6          Float?  // mg
  vitaminB12         Float?  // mcg
  folate             Float?  // mcg DFE
  thiamin            Float?  // mg (B1)
  riboflavin         Float?  // mg (B2)
  niacin             Float?  // mg (B3)

  servingSize String?
  notes       String?
  imageUrl    String?

  consumedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, consumedAt])
  @@index([userId, mealType])
}

model WaterIntake {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount    Float    // in ml
  recordedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, recordedAt])
}

model WeightRecord {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  weight    Float    // in kg
  recordedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, recordedAt])
}

// ============================================================================
// ML ENGINE MODELS
// ============================================================================

// Health Metrics - Time series data from wearables (RHR, HRV, sleep, etc.)
model HealthMetric {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamp (UTC, precise to second)
  recordedAt      DateTime

  // Metric type (enum for type safety)
  metricType      HealthMetricType

  // Value (flexible for different units)
  value           Float
  unit            String            // "bpm", "ms", "%", "steps", "kcal", etc.

  // Source (for data provenance)
  source          String            // "apple_health", "fitbit", "garmin", "oura", "whoop", "manual"
  sourceId        String?           // Original ID from source system

  // Metadata (JSON for flexibility)
  metadata        Json?             // {quality: "high", confidence: 0.95, device: "Apple Watch Series 9"}

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, recordedAt])
  @@index([userId, metricType, recordedAt])
  @@unique([userId, metricType, recordedAt, source])
}

// Activity - Exercise and movement data
model Activity {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timing
  startedAt       DateTime
  endedAt         DateTime
  duration        Int               // Duration in minutes

  // Type & Intensity
  activityType    ActivityType
  intensity       ActivityIntensity

  // Metrics
  caloriesBurned  Float?
  averageHeartRate Float?
  maxHeartRate    Float?
  distance        Float?            // In meters
  steps           Int?

  // Source
  source          String            // "apple_health", "strava", "garmin", "manual"
  sourceId        String?

  // Notes
  notes           String?

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, startedAt])
  @@index([userId, activityType, startedAt])
}

// ML Features - Pre-computed features for fast predictions
model MLFeature {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Temporal scope
  date            DateTime          // Date this feature represents (e.g., 2025-01-17)

  // Feature category
  category        MLFeatureCategory

  // Features (JSON for flexibility)
  features        Json              // {protein_7d_avg: 150, carbs_ratio: 0.4, meal_regularity: 0.85}

  // Metadata
  version         String            // "v1.2.3" - for feature engineering versioning

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, date, category])
  @@unique([userId, date, category, version])
}

// ML Predictions - Model outputs and tracking
model MLPrediction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What are we predicting?
  targetMetric    HealthMetricType
  targetDate      DateTime          // When is this prediction for?

  // Prediction
  predictedValue  Float
  confidence      Float             // 0.0 to 1.0
  predictionRange Json              // {lower: 55, upper: 61} for confidence intervals

  // Model metadata
  modelId         String            // "rhr_lstm_v2.1.0"
  modelVersion    String            // "2.1.0"

  // Feature importance (what drove this prediction?)
  featureImportance Json            // {protein_intake: 0.35, sleep_quality: 0.28, ...}

  // Actual outcome (for model evaluation)
  actualValue     Float?
  predictionError Float?            // Calculated after actual value is recorded

  // Audit
  createdAt       DateTime          @default(now())

  @@index([userId, targetDate, targetMetric])
  @@index([userId, modelId, createdAt])
}

// ML Insights - Actionable recommendations for users
model MLInsight {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Insight type
  insightType     MLInsightType
  priority        InsightPriority

  // Content
  title           String            // "Your carb timing affects sleep quality"
  description     String            // Detailed explanation
  recommendation  String            // "Try eating complex carbs earlier in the day"

  // Supporting data
  correlation     Float?            // Correlation coefficient (if applicable)
  confidence      Float             // How confident is the ML model? (0.0 to 1.0)
  dataPoints      Int               // How many data points support this insight?

  // Metadata
  metadata        Json?             // {chart_data: [...], references: [...]}

  // User interaction
  viewed          Boolean           @default(false)
  viewedAt        DateTime?
  dismissed       Boolean           @default(false)
  dismissedAt     DateTime?
  helpful         Boolean?          // User feedback: was this helpful?

  // Audit
  createdAt       DateTime          @default(now())
  expiresAt       DateTime?         // Some insights are time-sensitive

  @@index([userId, createdAt])
  @@index([userId, insightType, priority])
}

// User ML Profile - Per-user model configuration
model UserMLProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Data quality
  totalDataPoints Int      @default(0)
  dataQualityScore Float   @default(0.0) // 0.0 to 1.0

  // Minimum data requirements met?
  hasMinimumNutritionData   Boolean @default(false)
  hasMinimumHealthData      Boolean @default(false)
  hasMinimumActivityData    Boolean @default(false)

  // Model readiness
  modelsAvailable Json     // {rhr_prediction: true, hrv_prediction: false, ...}
  lastTrainingDate DateTime?

  // User preferences
  enablePredictions Boolean @default(true)
  enableInsights    Boolean @default(true)
  insightFrequency  String  @default("daily") // "daily", "weekly", "realtime"

  // Privacy
  shareDataForResearch Boolean @default(false)
  dataRetentionDays    Int     @default(365)

  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// SUPPLEMENT TRACKING
// ============================================================================

// Supplement - Definition of a supplement the user takes
model Supplement {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name            String              // e.g., "Vitamin D3", "Fish Oil", "Magnesium"
  brand           String?             // Optional brand name

  // Dosage
  dosageAmount    Float               // e.g., 1000, 2, 500
  dosageUnit      String              // e.g., "IU", "mg", "mcg", "g", "capsules", "tablets"

  // Schedule
  frequency       SupplementFrequency @default(DAILY)
  timesPerDay     Int                 @default(1) // How many times per day (for DAILY frequency)
  timeOfDay       SupplementTimeOfDay[] // When to take (morning, afternoon, evening, etc.)
  withFood        Boolean             @default(false) // Should be taken with food

  // Status
  isActive        Boolean             @default(true) // Currently taking this supplement
  startDate       DateTime            @default(now())
  endDate         DateTime?           // When they stopped taking it (null if still active)

  // Additional info
  notes           String?             // Any notes about the supplement
  color           String?             // Optional color for UI display (hex code)

  // Micronutrient content (estimated or from barcode)
  // Vitamins (optional)
  vitaminA        Float?              // mcg RAE
  vitaminC        Float?              // mg
  vitaminD        Float?              // mcg
  vitaminE        Float?              // mg
  vitaminK        Float?              // mcg
  vitaminB6       Float?              // mg
  vitaminB12      Float?              // mcg
  folate          Float?              // mcg DFE
  thiamin         Float?              // mg (B1)
  riboflavin      Float?              // mg (B2)
  niacin          Float?              // mg (B3)

  // Minerals (optional)
  calcium         Float?              // mg
  iron            Float?              // mg
  magnesium       Float?              // mg
  zinc            Float?              // mg
  potassium       Float?              // mg
  sodium          Float?              // mg
  phosphorus      Float?              // mg

  // Special nutrients (optional)
  omega3          Float?              // mg (total EPA + DHA)

  // Relations
  logs            SupplementLog[]

  // Audit
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, isActive])
  @@index([userId, createdAt])
}

// SupplementLog - Record of when a supplement was taken
model SupplementLog {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplementId    String
  supplement      Supplement  @relation(fields: [supplementId], references: [id], onDelete: Cascade)

  // When it was taken
  takenAt         DateTime    @default(now())

  // Optional details
  dosageAmount    Float?      // Override if different from standard dose
  notes           String?     // Any notes for this specific dose
  skipped         Boolean     @default(false) // Marked as intentionally skipped

  // Audit
  createdAt       DateTime    @default(now())

  @@index([userId, takenAt])
  @@index([supplementId, takenAt])
  @@index([userId, supplementId, takenAt])
}

// ============================================================================
// ENUMS
// ============================================================================

enum SupplementFrequency {
  DAILY
  TWICE_DAILY
  THREE_TIMES_DAILY
  WEEKLY
  EVERY_OTHER_DAY
  AS_NEEDED
}

enum SupplementTimeOfDay {
  MORNING
  AFTERNOON
  EVENING
  BEFORE_BED
  WITH_BREAKFAST
  WITH_LUNCH
  WITH_DINNER
  EMPTY_STOMACH
}

enum SubscriptionTier {
  FREE
  PRO_TRIAL
  PRO
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum HealthMetricType {
  // Cardiovascular
  RESTING_HEART_RATE
  HEART_RATE_VARIABILITY_SDNN
  HEART_RATE_VARIABILITY_RMSSD
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC

  // Respiratory
  RESPIRATORY_RATE
  OXYGEN_SATURATION
  VO2_MAX

  // Sleep
  SLEEP_DURATION
  DEEP_SLEEP_DURATION
  REM_SLEEP_DURATION
  SLEEP_EFFICIENCY
  SLEEP_SCORE

  // Activity
  STEPS
  ACTIVE_CALORIES
  TOTAL_CALORIES
  EXERCISE_MINUTES
  STANDING_HOURS

  // Recovery & Strain
  RECOVERY_SCORE
  STRAIN_SCORE
  READINESS_SCORE

  // Body Composition
  BODY_FAT_PERCENTAGE
  MUSCLE_MASS
  BONE_MASS
  WATER_PERCENTAGE

  // Other
  SKIN_TEMPERATURE
  BLOOD_GLUCOSE
  STRESS_LEVEL
}

enum ActivityType {
  // Cardio
  RUNNING
  CYCLING
  SWIMMING
  WALKING
  HIKING
  ROWING
  ELLIPTICAL

  // Strength
  WEIGHT_TRAINING
  BODYWEIGHT
  CROSSFIT
  POWERLIFTING

  // Sports
  BASKETBALL
  SOCCER
  TENNIS
  GOLF

  // Other
  YOGA
  PILATES
  STRETCHING
  MARTIAL_ARTS
  DANCE
  OTHER
}

enum ActivityIntensity {
  LOW
  MODERATE
  HIGH
  MAXIMUM
}

enum MLFeatureCategory {
  NUTRITION_DAILY
  NUTRITION_WEEKLY
  NUTRITION_TEMPORAL
  ACTIVITY_DAILY
  ACTIVITY_WEEKLY
  HEALTH_DAILY
  HEALTH_WEEKLY
  COMBINED_FEATURES
}

enum MLInsightType {
  CORRELATION
  PREDICTION
  ANOMALY
  RECOMMENDATION
  GOAL_PROGRESS
  PATTERN_DETECTED
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
