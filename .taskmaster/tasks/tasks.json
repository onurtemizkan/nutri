{
  "master": {
    "tasks": [
      {
        "id": "2",
        "title": "Implement Real Food Classification ML Model",
        "description": "Replace the mock food classifier in ml-service/app/services/food_analysis_service.py with a real CNN model (EfficientNet or ResNet) trained on food image datasets.",
        "details": "1. Create a new module `ml-service/app/ml_models/food_classifier.py` with:\n   - Load pre-trained EfficientNet-B0 or ResNet-50 from torchvision\n   - Fine-tune on Food-101 dataset or custom food dataset\n   - Implement proper image preprocessing pipeline matching ImageNet stats\n   - Support for GPU inference if available (auto-detect CUDA)\n\n2. Update `food_analysis_service.py`:\n   - Replace `NUTRITION_DATABASE` with a proper food database (USDA FoodData Central API integration)\n   - Update `_classify_food()` to use real model inference instead of random selection\n   - Add model loading with caching to avoid reloading on each request\n   - Implement top-5 predictions with confidence scores\n\n3. Add model versioning:\n   - Store model checkpoints in `ml-service/models/food_classifier/`\n   - Add `model_version` field to responses\n   - Implement A/B testing capability by loading multiple model versions\n\n4. Extend nutrition database:\n   - Expand from current 6 items to 100+ common foods\n   - Structure: JSON file or SQLite database with USDA data\n   - Include serving size variations (small, medium, large)\n\nPseudo-code for classifier:\n```python\nclass FoodClassifier:\n    def __init__(self, model_path: str = None):\n        self.model = self._load_model(model_path)\n        self.classes = self._load_class_labels()\n    \n    def _load_model(self, path):\n        model = torchvision.models.efficientnet_b0(pretrained=True)\n        model.classifier[-1] = nn.Linear(1280, num_food_classes)\n        if path:\n            model.load_state_dict(torch.load(path))\n        model.eval()\n        return model\n    \n    async def classify(self, image: np.ndarray) -> List[Tuple[str, float]]:\n        tensor = self._preprocess(image)\n        with torch.no_grad():\n            outputs = self.model(tensor)\n            probs = torch.softmax(outputs, dim=1)\n        return self._get_top_k(probs, k=5)\n```",
        "testStrategy": "1. Unit tests for model loading and inference\n2. Test classification accuracy on held-out test set (target >80% top-5)\n3. Integration test: POST /api/food/analyze with real food images\n4. Performance test: Inference time <3s per image\n5. Test model fallback when GPU not available",
        "priority": "high",
        "dependencies": [],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "3",
        "title": "Build Health Metrics Mobile UI Screens",
        "description": "Create mobile screens for viewing and manually entering health metrics (RHR, HRV, sleep, recovery). Backend API is complete at /api/health-metrics.",
        "details": "1. Create new screens in `app/` directory:\n   - `app/health/index.tsx` - Health metrics dashboard/list\n   - `app/health/[id].tsx` - Detail view for specific metric\n   - `app/health/add.tsx` - Manual entry form\n\n2. Health Dashboard (`app/health/index.tsx`):\n   - Display today's key metrics in cards (RHR, HRV, Sleep, Recovery)\n   - Time range selector: Today, Week, Month\n   - Pull-to-refresh functionality\n   - Navigate to detail view on tap\n\n3. Metric Detail View (`app/health/[id].tsx`):\n   - Line chart showing metric over time (use react-native-chart-kit or Victory Native)\n   - Statistics: avg, min, max, trend arrow\n   - Data source indicator (Apple Health, Fitbit, Manual)\n   - Date range filter\n\n4. Manual Entry Form (`app/health/add.tsx`):\n   - Metric type picker (dropdown with all HealthMetricType enum values)\n   - Value input with unit display (bpm, ms, hours, %)\n   - Date/time picker (defaults to now)\n   - Source set to 'MANUAL'\n   - Validation: min/max ranges per metric type\n\n5. Create API client in `lib/api/health-metrics.ts`:\n```typescript\nexport const healthMetricsApi = {\n  getAll: (params: { startDate?: string; endDate?: string; metricType?: string }) => \n    apiClient.get('/health-metrics', { params }),\n  getById: (id: string) => apiClient.get(`/health-metrics/${id}`),\n  create: (data: CreateHealthMetricInput) => apiClient.post('/health-metrics', data),\n  getDailySummary: (date: string) => apiClient.get(`/health-metrics/daily/${date}`),\n}\n```\n\n6. Add navigation:\n   - Add 'Health' tab to bottom navigation in `app/(tabs)/_layout.tsx`\n   - Use health heart icon from @expo/vector-icons\n<info added on 2025-12-05T01:32:13.931Z>\nNow I have a comprehensive understanding of the codebase's styling patterns, typography, colors, and testing conventions. Let me provide the update text:\n\n7. Styling and UX Consistency Requirements:\n\nAll Health Metrics screens must follow the established design system in `lib/theme/colors.ts`:\n- Use `colors.background.primary` (#0F1419) as main background\n- Use `colors.background.tertiary` (#1E2330) for cards and surfaces\n- Use `colors.primary.main` (#8B5CF6) for interactive elements\n- Apply `gradients.primary` (purple-pink) for CTAs and active states\n- Text: `colors.text.primary` for headings, `colors.text.tertiary` for labels\n- Use `spacing` constants (xs:4, sm:8, md:16, lg:24, xl:32)\n- Apply `borderRadius` constants (sm:8, md:12, lg:16)\n- Use `typography.fontSize` and `typography.fontWeight` for consistent text styling\n- Import theme tokens: `import { colors, gradients, shadows, spacing, borderRadius, typography } from '@/lib/theme/colors'`\n\nMatch existing UX patterns from `app/(tabs)/index.tsx` and `app/add-meal.tsx`:\n- Cards with `borderWidth: 1, borderColor: colors.border.secondary`\n- Section titles: `fontSize: typography.fontSize['2xl']` or `lg`, `fontWeight: bold/semibold`\n- Form inputs: Height 48px, `backgroundColor: colors.background.tertiary`, `borderRadius: borderRadius.md`\n- Pull-to-refresh using `RefreshControl` with `tintColor={colors.primary.main}`\n- Loading states with `ActivityIndicator` using `colors.primary.main`\n- FAB pattern: 56x56 with LinearGradient and `shadows.xl`\n- SafeAreaView container with ScrollView using `showsVerticalScrollIndicator={false}`\n\n8. Comprehensive Test Requirements:\n\nCreate mobile component tests in `__tests__/` directory using react-native-testing-library:\n\nTest file structure:\n- `__tests__/screens/health/HealthDashboard.test.tsx`\n- `__tests__/screens/health/HealthMetricDetail.test.tsx`\n- `__tests__/screens/health/AddHealthMetric.test.tsx`\n- `__tests__/api/health-metrics.test.ts`\n\nRequired test coverage per screen:\n\nHealthDashboard tests:\n- Renders loading state with ActivityIndicator\n- Renders metric cards for RHR, HRV, Sleep, Recovery when data exists\n- Renders empty state when no health data available\n- Time range selector changes displayed data (Today/Week/Month)\n- Pull-to-refresh triggers API reload\n- Tapping metric card navigates to detail view\n- Error state rendering when API fails\n\nHealthMetricDetail tests:\n- Renders line chart with historical data\n- Displays statistics (avg, min, max, trend)\n- Shows correct data source indicator (Apple Health, Fitbit, Manual)\n- Date range filter updates chart data\n- Handles empty data gracefully\n- Loading and error states\n\nAddHealthMetric (Manual Entry) tests:\n- Metric type picker renders all HealthMetricType enum values\n- Value input accepts numeric input with correct units per type\n- Date/time picker defaults to current time\n- Source automatically set to MANUAL\n- Validation errors for out-of-range values (per metric type)\n- Required field validation\n- Successful submission calls API and navigates back\n- Cancel button discards changes and navigates back\n- Form disabled during submission\n\nAPI client tests (`lib/api/health-metrics.ts`):\n- Follow existing patterns from `__tests__/unit/api/food-analysis.test.ts`\n- Mock axios using `jest.mock('axios')`\n- Test getAll with various query params (startDate, endDate, metricType)\n- Test getById returns single metric\n- Test create sends correct payload and returns created metric\n- Test getDailySummary formats date correctly\n- Test error handling with proper error messages\n\nUse test patterns from existing tests:\n- Arrange, Act, Assert pattern\n- Mock dependencies with `jest.mock()`\n- Use `waitFor` for async assertions\n- Test user interactions with `fireEvent`\n</info added on 2025-12-05T01:32:13.931Z>",
        "testStrategy": "1. Component tests for each screen using react-native-testing-library\n2. Test form validation for manual entry\n3. Test API integration with mock server\n4. Visual regression tests for chart rendering\n5. Test pull-to-refresh behavior\n6. Test empty state when no health data exists",
        "priority": "high",
        "dependencies": [],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Create TypeScript types for health metrics in lib/types/health-metrics.ts",
            "description": "Define TypeScript interfaces and types for health metrics to be used across the mobile app, matching the backend API contracts.",
            "dependencies": [],
            "details": "Create `lib/types/health-metrics.ts` with the following types:\n\n1. **HealthMetricType enum** - Match the 28 types from `server/src/validation/schemas.ts` healthMetricTypeSchema: RESTING_HEART_RATE, HEART_RATE_VARIABILITY_SDNN, HEART_RATE_VARIABILITY_RMSSD, BLOOD_PRESSURE_SYSTOLIC, BLOOD_PRESSURE_DIASTOLIC, RESPIRATORY_RATE, OXYGEN_SATURATION, VO2_MAX, SLEEP_DURATION, DEEP_SLEEP_DURATION, REM_SLEEP_DURATION, SLEEP_EFFICIENCY, SLEEP_SCORE, STEPS, ACTIVE_CALORIES, TOTAL_CALORIES, EXERCISE_MINUTES, STANDING_HOURS, RECOVERY_SCORE, STRAIN_SCORE, READINESS_SCORE, BODY_FAT_PERCENTAGE, MUSCLE_MASS, BONE_MASS, WATER_PERCENTAGE, SKIN_TEMPERATURE, BLOOD_GLUCOSE, STRESS_LEVEL\n\n2. **HealthMetricSource type** - Match `server/src/validation/schemas.ts` healthMetricSourceSchema: 'apple_health' | 'fitbit' | 'garmin' | 'oura' | 'whoop' | 'manual'\n\n3. **HealthMetric interface** - Based on backend response: id, userId, metricType, value, unit, recordedAt, source, sourceId?, metadata?, createdAt, updatedAt\n\n4. **CreateHealthMetricInput interface** - Match `server/src/validation/schemas.ts` createHealthMetricSchema: metricType, value, unit, recordedAt (ISO string), source, sourceId?, metadata?\n\n5. **HealthMetricStats interface** - For stats endpoint: average, min, max, count, trend ('up' | 'down' | 'stable'), percentChange\n\n6. **TimeSeriesDataPoint interface** - For charts: date (string), value, source?\n\n7. **METRIC_CONFIG constant** - Unit and display info per metric type: { unit: string, displayName: string, minValue?: number, maxValue?: number, icon?: string }. Example: RESTING_HEART_RATE: { unit: 'bpm', displayName: 'Resting Heart Rate', minValue: 30, maxValue: 220 }",
            "status": "done",
            "testStrategy": null,
            "updatedAt": "2025-12-05T01:39:21.568Z",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Create health metrics API client in lib/api/health-metrics.ts",
            "description": "Implement API client functions to communicate with the backend health metrics endpoints, following the existing mealsApi pattern in lib/api/meals.ts.",
            "dependencies": [
              1
            ],
            "details": "Create `lib/api/health-metrics.ts` following the pattern from `lib/api/meals.ts`:\n\n```typescript\nimport api from './client';\nimport { HealthMetric, CreateHealthMetricInput, HealthMetricStats, TimeSeriesDataPoint, HealthMetricType, HealthMetricSource } from '../types/health-metrics';\n\nexport interface GetHealthMetricsParams {\n  metricType?: HealthMetricType;\n  startDate?: string;\n  endDate?: string;\n  source?: HealthMetricSource;\n  limit?: number;\n}\n\nexport const healthMetricsApi = {\n  // POST /health-metrics - Create single metric\n  async create(data: CreateHealthMetricInput): Promise<HealthMetric>,\n\n  // GET /health-metrics - Get all with optional filters\n  async getAll(params?: GetHealthMetricsParams): Promise<HealthMetric[]>,\n\n  // GET /health-metrics/:id - Get by ID\n  async getById(id: string): Promise<HealthMetric>,\n\n  // GET /health-metrics/latest/:metricType - Get latest value for a metric type\n  async getLatest(metricType: HealthMetricType): Promise<HealthMetric | null>,\n\n  // GET /health-metrics/timeseries/:metricType - Get time series data for charts\n  async getTimeSeries(metricType: HealthMetricType, startDate?: string, endDate?: string): Promise<TimeSeriesDataPoint[]>,\n\n  // GET /health-metrics/stats/:metricType - Get statistics (avg, min, max, trend)\n  async getStats(metricType: HealthMetricType, days?: number): Promise<HealthMetricStats>,\n\n  // GET /health-metrics/average/daily/:metricType - Get daily average\n  async getDailyAverage(metricType: HealthMetricType, date?: string): Promise<{ average: number; count: number }>,\n\n  // GET /health-metrics/average/weekly/:metricType - Get weekly average\n  async getWeeklyAverage(metricType: HealthMetricType): Promise<{ average: number; count: number }>,\n\n  // DELETE /health-metrics/:id - Delete metric\n  async delete(id: string): Promise<void>,\n};\n```\n\nUse the existing `api` client from `./client` which handles JWT auth token injection. Match the routes from `server/src/routes/healthMetricRoutes.ts`.",
            "status": "done",
            "testStrategy": null,
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:39:52.642Z"
          },
          {
            "id": 3,
            "title": "Add Health tab to bottom navigation in app/(tabs)/_layout.tsx",
            "description": "Add a new 'Health' tab to the existing tab navigation using a heart icon, maintaining consistency with the current tab styling.",
            "dependencies": [],
            "details": "Modify `app/(tabs)/_layout.tsx` to add the Health tab:\n\n1. Add the 'heart.fill' SF Symbol to the MAPPING in `components/ui/IconSymbol.tsx`:\n```typescript\n'heart.fill': 'favorite',  // MaterialIcons mapping\n'person.fill': 'person',   // Already exists\n```\n\n2. Add new Tabs.Screen in `app/(tabs)/_layout.tsx` after the index tab and before profile:\n```typescript\n<Tabs.Screen\n  name=\"health\"\n  options={{\n    title: 'Health',\n    tabBarIcon: ({ color }) => <IconSymbol size={28} name=\"heart.fill\" color={color} />,\n  }}\n/>\n```\n\n3. Ensure the tab follows existing styling from tabBarStyle with:\n- `tabBarActiveTintColor: colors.primary.main` (purple #8B5CF6)\n- `tabBarInactiveTintColor: colors.text.disabled` (gray #6B7280)\n- Same height and padding as other tabs\n\n4. Export IconSymbolName type must include 'heart.fill' for TypeScript safety.",
            "status": "done",
            "testStrategy": null,
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:40:18.178Z"
          },
          {
            "id": 4,
            "title": "Create Health Dashboard screen at app/(tabs)/health.tsx",
            "description": "Build the main Health Dashboard screen displaying today's key metrics (RHR, HRV, Sleep, Recovery) in cards with time range selector and pull-to-refresh.",
            "dependencies": [
              1,
              2,
              3
            ],
            "details": "Create `app/(tabs)/health.tsx` following patterns from `app/(tabs)/index.tsx`:\n\n**Imports:**\n- React hooks: useState, useEffect, useCallback\n- Components: View, Text, StyleSheet, ScrollView, TouchableOpacity, RefreshControl, ActivityIndicator\n- expo-router: useRouter\n- SafeAreaView from react-native-safe-area-context\n- LinearGradient from expo-linear-gradient\n- Theme: colors, gradients, shadows, spacing, borderRadius, typography from '@/lib/theme/colors'\n- API: healthMetricsApi from '@/lib/api/health-metrics'\n- Types: HealthMetric, HealthMetricStats, METRIC_CONFIG from '@/lib/types/health-metrics'\n\n**State:**\n- metrics: Record<HealthMetricType, { latest: HealthMetric | null; stats: HealthMetricStats | null }>\n- timeRange: 'today' | 'week' | 'month' (default 'today')\n- isLoading: boolean, refreshing: boolean\n\n**Layout Structure:**\n1. Header with title \"Health\" and date (matches index.tsx greeting style: fontSize: typography.fontSize['3xl'], fontWeight: bold)\n2. Time Range Selector (horizontal buttons like meal type selector in add-meal.tsx)\n3. Metric Cards Grid (2x2) for: RESTING_HEART_RATE, HEART_RATE_VARIABILITY_SDNN, SLEEP_DURATION, RECOVERY_SCORE\n\n**Each Metric Card (TouchableOpacity):**\n- backgroundColor: colors.background.tertiary\n- borderWidth: 1, borderColor: colors.border.secondary\n- borderRadius: borderRadius.lg\n- padding: spacing.md\n- Icon (use Ionicons: heart-outline, pulse-outline, moon-outline, fitness-outline)\n- Label (colors.text.tertiary, fontSize: typography.fontSize.sm)\n- Value (colors.text.primary, fontSize: typography.fontSize['2xl'], fontWeight: bold)\n- Unit (colors.text.tertiary)\n- Trend indicator arrow (green up, red down, gray stable)\n- onPress: router.push(`/health/${metricType}`)\n\n**Pull-to-refresh:** Use RefreshControl with tintColor={colors.primary.main}\n\n**Loading State:** ActivityIndicator centered with colors.primary.main\n\n**Empty State:** \"No health data yet. Add your first metric!\" with button to /health/add",
            "status": "done",
            "testStrategy": null,
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:41:25.915Z"
          },
          {
            "id": 5,
            "title": "Create Metric Detail screen at app/health/[metricType].tsx",
            "description": "Build the detail view for a specific health metric showing historical line chart, statistics (avg, min, max, trend), date range filter, and data source indicator.",
            "dependencies": [
              1,
              2
            ],
            "details": "Create `app/health/[metricType].tsx` as a dynamic route screen:\n\n**Imports:**\n- useLocalSearchParams from expo-router to get metricType param\n- LineChart from react-native-chart-kit (install if needed) or VictoryLine from victory-native\n- All theme imports from lib/theme/colors\n- healthMetricsApi and types\n\n**State:**\n- timeSeries: TimeSeriesDataPoint[] for chart data\n- stats: HealthMetricStats | null\n- dateRange: '7d' | '30d' | '90d' (default '30d')\n- isLoading: boolean\n\n**Layout:**\n1. **Header** with back button (TouchableOpacity with Ionicons chevron-back) and metric display name from METRIC_CONFIG\n\n2. **Date Range Selector** - Horizontal buttons matching add-meal.tsx mealTypeContainer style:\n   - 7 Days, 30 Days, 90 Days\n   - Active: LinearGradient with gradients.primary\n   - Inactive: backgroundColor: colors.background.tertiary\n\n3. **Line Chart** (full width, height ~200):\n   - backgroundColor: colors.background.tertiary\n   - Line color: colors.primary.main (#8B5CF6)\n   - Grid lines: colors.border.secondary\n   - Labels: colors.text.tertiary\n   - Data points from timeSeries API response\n\n4. **Statistics Card** (similar to macrosContainer in index.tsx):\n   - Three columns: Average, Minimum, Maximum\n   - Each shows value with unit\n   - fontSize: typography.fontSize.xl for values\n   - backgroundColor: colors.background.tertiary\n   - borderRadius: borderRadius.md\n\n5. **Trend Section:**\n   - Arrow icon (trending-up/down/minus from Ionicons)\n   - Percentage change text\n   - Color: status.success (green) for up, status.error (red) for down\n\n6. **Data Source Badge:**\n   - Icon per source (Apple Health, Fitbit, Manual, etc.)\n   - Text showing source name\n   - colors.text.tertiary styling\n\n**Chart Config (react-native-chart-kit):**\n```typescript\nchartConfig: {\n  backgroundColor: colors.background.tertiary,\n  backgroundGradientFrom: colors.background.tertiary,\n  backgroundGradientTo: colors.background.tertiary,\n  color: (opacity = 1) => `rgba(139, 92, 246, ${opacity})`, // primary.main\n  labelColor: (opacity = 1) => `rgba(156, 163, 175, ${opacity})`, // text.tertiary\n  strokeWidth: 2,\n}\n```",
            "status": "done",
            "testStrategy": null,
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:43:39.003Z"
          },
          {
            "id": 6,
            "title": "Create Manual Entry form at app/health/add.tsx",
            "description": "Build the form for manually entering health metrics with metric type picker, value input with dynamic units, date/time picker, and validation for min/max ranges per metric type.",
            "dependencies": [
              1,
              2
            ],
            "details": "Create `app/health/add.tsx` following the pattern from `app/add-meal.tsx`:\n\n**Imports:**\n- useState, useEffect from react\n- All RN components: View, Text, TextInput, TouchableOpacity, StyleSheet, ScrollView, KeyboardAvoidingView, Platform, ActivityIndicator\n- useRouter from expo-router\n- SafeAreaView, LinearGradient, Ionicons\n- DateTimePicker from @react-native-community/datetimepicker (or expo-date-time-picker)\n- Picker from @react-native-picker/picker\n- healthMetricsApi, CreateHealthMetricInput, HealthMetricType, METRIC_CONFIG\n- colors, gradients, spacing, borderRadius, typography from theme\n- showAlert from '@/lib/utils/alert'\n- getErrorMessage from '@/lib/utils/errorHandling'\n\n**State:**\n- metricType: HealthMetricType (default 'RESTING_HEART_RATE')\n- value: string (for TextInput)\n- recordedAt: Date (default new Date())\n- isLoading: boolean\n- showDatePicker: boolean\n- errors: { value?: string }\n\n**Layout (match add-meal.tsx structure):**\n1. **Header** - Same as add-meal: Cancel (left), \"Add Health Metric\" (center), Save (right)\n   - Cancel: text style, color: colors.text.secondary\n   - Save: text style, color: colors.primary.main, disabled when isLoading\n\n2. **Metric Type Picker Section:**\n   - Label: \"Metric Type\" (styles.sectionTitle)\n   - Dropdown picker with all 28 HealthMetricType values\n   - Group by category: Cardiovascular, Sleep, Activity, Recovery, Body Composition\n   - Display friendly names from METRIC_CONFIG.displayName\n\n3. **Value Input Section:**\n   - Label: \"Value ({unit})\" - dynamically show unit from METRIC_CONFIG[metricType].unit\n   - TextInput with keyboardType=\"decimal-pad\"\n   - Height 48px, backgroundColor: colors.background.tertiary\n   - Validation message below if out of range (colors.status.error)\n\n4. **Date/Time Picker Section:**\n   - Label: \"Recorded At\"\n   - TouchableOpacity showing formatted date/time\n   - Opens DateTimePicker modal\n   - Default to current time\n\n5. **Source Badge** (non-editable):\n   - Shows \"Manual\" with checkmark icon\n   - Subtle styling: colors.special.highlight background\n\n**Validation:**\n- Value required and numeric\n- Check against METRIC_CONFIG[metricType].minValue and maxValue\n- Show inline error: \"Value must be between {min} and {max} {unit}\"\n\n**handleSave:**\n```typescript\nconst data: CreateHealthMetricInput = {\n  metricType,\n  value: parseFloat(value),\n  unit: METRIC_CONFIG[metricType].unit,\n  recordedAt: recordedAt.toISOString(),\n  source: 'manual',\n};\nawait healthMetricsApi.create(data);\nshowAlert('Success', 'Health metric added!', [{ text: 'OK', onPress: () => router.back() }]);\n```",
            "status": "done",
            "testStrategy": null,
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:45:06.446Z"
          },
          {
            "id": 7,
            "title": "Write unit tests for health-metrics API client",
            "description": "Create comprehensive unit tests for lib/api/health-metrics.ts following the existing test patterns from __tests__/unit/api/food-analysis.test.ts.",
            "dependencies": [
              2
            ],
            "details": "Create `__tests__/unit/api/health-metrics.test.ts`:\n\n**Setup:**\n```typescript\nimport axios from 'axios';\nimport { healthMetricsApi } from '@/lib/api/health-metrics';\nimport { HealthMetric, HealthMetricType, HealthMetricStats, TimeSeriesDataPoint } from '@/lib/types/health-metrics';\n\njest.mock('axios');\nconst mockedAxios = axios as jest.Mocked<typeof axios>;\n```\n\n**Test Fixtures:**\n```typescript\nconst mockHealthMetric: HealthMetric = {\n  id: 'metric-1',\n  userId: 'user-1',\n  metricType: 'RESTING_HEART_RATE',\n  value: 62,\n  unit: 'bpm',\n  recordedAt: '2024-01-15T08:00:00Z',\n  source: 'manual',\n  createdAt: '2024-01-15T08:00:00Z',\n  updatedAt: '2024-01-15T08:00:00Z',\n};\n\nconst mockStats: HealthMetricStats = {\n  average: 65,\n  min: 58,\n  max: 72,\n  count: 30,\n  trend: 'down',\n  percentChange: -3.5,\n};\n```\n\n**Test Cases:**\n\n1. **create():**\n   - Should successfully create a health metric\n   - Should send correct payload format to POST /health-metrics\n   - Should handle validation errors (400)\n   - Should handle auth errors (401)\n\n2. **getAll():**\n   - Should return array of metrics\n   - Should pass query params (metricType, startDate, endDate, source, limit)\n   - Should handle empty results\n   - Should handle network errors\n\n3. **getById():**\n   - Should return single metric by ID\n   - Should handle 404 not found\n\n4. **getLatest():**\n   - Should return latest metric for type\n   - Should return null when no metrics exist\n\n5. **getTimeSeries():**\n   - Should return array of data points for chart\n   - Should pass date range params\n   - Should handle empty data gracefully\n\n6. **getStats():**\n   - Should return stats with average, min, max, trend\n   - Should pass days param\n   - Should handle 404 when no data\n\n7. **getDailyAverage() and getWeeklyAverage():**\n   - Should return average and count\n   - Should handle date param for daily\n\n8. **delete():**\n   - Should successfully delete metric\n   - Should handle 404 errors\n\n**Pattern:** Use Arrange, Act, Assert. Mock `api.get`, `api.post`, `api.delete` from the client module.",
            "status": "done",
            "testStrategy": "Run with `npm test __tests__/unit/api/health-metrics.test.ts`. Verify all API methods are tested with success and error cases. Check coverage with `npm run test:coverage`.",
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:46:30.103Z"
          },
          {
            "id": 8,
            "title": "Write component tests for Health screens",
            "description": "Create comprehensive component tests for HealthDashboard, HealthMetricDetail, and AddHealthMetric screens using react-native-testing-library.",
            "dependencies": [
              4,
              5,
              6
            ],
            "details": "Create test files in `__tests__/screens/health/` directory:\n\n**1. __tests__/screens/health/HealthDashboard.test.tsx:**\n```typescript\nimport React from 'react';\nimport { render, fireEvent, waitFor } from '@testing-library/react-native';\nimport HealthDashboard from '@/app/(tabs)/health';\nimport { healthMetricsApi } from '@/lib/api/health-metrics';\n\njest.mock('@/lib/api/health-metrics');\njest.mock('expo-router', () => ({ useRouter: () => ({ push: jest.fn() }) }));\njest.mock('@/lib/context/AuthContext', () => ({ useAuth: () => ({ user: { id: '1', name: 'Test' } }) }));\n```\n\nTest cases:\n- Renders loading state with ActivityIndicator initially\n- Renders metric cards when data loads successfully\n- Renders empty state when no health data available\n- Time range selector updates displayed data (Today/Week/Month)\n- Pull-to-refresh triggers API reload (test RefreshControl onRefresh)\n- Tapping metric card calls router.push with correct metric type\n- Error state renders when API fails\n\n**2. __tests__/screens/health/HealthMetricDetail.test.tsx:**\n\nTest cases:\n- Renders line chart with historical data points\n- Displays statistics (avg, min, max, trend arrow, percentage)\n- Shows correct data source indicator icon/text\n- Date range filter buttons update chart data (7d/30d/90d)\n- Handles empty data gracefully with message\n- Loading state shows ActivityIndicator\n- Error state with retry button\n\n**3. __tests__/screens/health/AddHealthMetric.test.tsx:**\n\nTest cases:\n- Metric type picker renders all HealthMetricType enum values\n- Value input accepts numeric input and shows correct unit dynamically\n- Date/time picker defaults to current time and opens modal\n- Source automatically displays \"Manual\"\n- Shows validation error for out-of-range values (test per metric type bounds)\n- Shows required field validation when value empty\n- Successful submission calls API and navigates back\n- Cancel button navigates back without saving\n- Form inputs disabled during submission (isLoading state)\n- Shows loading indicator on Save button during submission\n\n**Common Mocks:**\n- Mock @react-native-community/datetimepicker\n- Mock @react-native-picker/picker\n- Mock react-native-chart-kit or victory-native\n- Mock expo-linear-gradient",
            "status": "in-progress",
            "testStrategy": "Run with `npm test __tests__/screens/health/`. Verify all user interactions are tested. Use `fireEvent` for button presses and text input. Use `waitFor` for async operations. Target 80%+ coverage for all three screens.",
            "parentId": "undefined",
            "updatedAt": "2025-12-05T01:46:30.166Z"
          }
        ],
        "updatedAt": "2025-12-05T01:59:24.616Z"
      },
      {
        "id": "4",
        "title": "Build Activity Tracking Mobile UI Screens",
        "description": "Create mobile screens for viewing and manually logging activities. Backend API is complete at /api/activities.",
        "details": "1. Create new screens in `app/` directory:\n   - `app/activity/index.tsx` - Activity list/history\n   - `app/activity/[id].tsx` - Activity detail view\n   - `app/activity/add.tsx` - Manual activity entry form\n\n2. Activity List (`app/activity/index.tsx`):\n   - Weekly summary card: total minutes, calories, workout count\n   - Filter by activity type (All, Cardio, Strength, Flexibility)\n   - List of recent activities with icon, duration, calories\n   - Floating action button to add new activity\n   - Pull-to-refresh\n\n3. Activity Detail View (`app/activity/[id].tsx`):\n   - Display all activity fields: type, duration, intensity, calories\n   - Heart rate data if available (avg, max)\n   - Distance and steps for applicable activities\n   - Notes field\n   - Edit/Delete buttons\n\n4. Manual Entry Form (`app/activity/add.tsx`):\n   - Activity type picker (21 types from ActivityType enum)\n   - Intensity picker (Low, Moderate, High, Maximum)\n   - Duration input (hours:minutes picker)\n   - Date/time pickers for start time\n   - Optional fields: calories, heart rate, distance, notes\n   - Validation: duration > 0, end time > start time\n\n5. Create API client in `lib/api/activities.ts`:\n```typescript\nexport const activitiesApi = {\n  getAll: (params?: { activityType?: string; startDate?: string }) =>\n    apiClient.get('/activities', { params }),\n  getById: (id: string) => apiClient.get(`/activities/${id}`),\n  create: (data: CreateActivityInput) => apiClient.post('/activities', data),\n  update: (id: string, data: Partial<CreateActivityInput>) =>\n    apiClient.put(`/activities/${id}`, data),\n  delete: (id: string) => apiClient.delete(`/activities/${id}`),\n  getWeeklySummary: () => apiClient.get('/activities/weekly-summary'),\n}\n```\n\n6. Add activity icons mapping for different activity types",
        "testStrategy": "1. Component tests for each screen\n2. Test form validation (duration, time constraints)\n3. Test activity type filtering\n4. Test CRUD operations with mock API\n5. Test weekly summary calculation display\n6. Test edit/delete flows with confirmation dialogs",
        "priority": "high",
        "dependencies": [],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "5",
        "title": "Implement Apple HealthKit Integration",
        "description": "Enable automatic sync of comprehensive health data from Apple HealthKit including cardiovascular metrics (RHR, Heart Rate, HRV SDNN/RMSSD), sleep quality metrics (duration, deep sleep, REM, efficiency, score), respiratory data (respiratory rate, oxygen saturation), and VO2Max.",
        "status": "in-progress",
        "dependencies": [
          "3",
          "4"
        ],
        "priority": "medium",
        "details": "1. Install and configure react-native-health (recommended for Expo managed workflow):\n   - Add `react-native-health` to package.json dependencies\n   - Configure `app.json` with NSHealthShareUsageDescription and NSHealthUpdateUsageDescription\n   - Add HealthKit entitlement to iOS build configuration\n   - Request HealthKit permissions on iOS for all metric types\n\n2. **Schema Consideration**: The existing Prisma HealthMetricType enum in `server/prisma/schema.prisma` already supports:\n   - Cardiovascular: `RESTING_HEART_RATE`, `HEART_RATE_VARIABILITY_SDNN`, `HEART_RATE_VARIABILITY_RMSSD`\n   - Respiratory: `RESPIRATORY_RATE`, `OXYGEN_SATURATION`, `VO2_MAX`\n   - Sleep: `SLEEP_DURATION`, `DEEP_SLEEP_DURATION`, `REM_SLEEP_DURATION`, `SLEEP_EFFICIENCY`, `SLEEP_SCORE`\n   - NOTE: Consider adding `HEART_RATE` (instantaneous/average HR, separate from resting) if needed for workout HR data\n\n3. Create health sync service in `lib/services/healthkit.ts`:\n```typescript\nexport interface HealthKitConfig {\n  permissions: {\n    read: HealthKitPermission[];\n    write?: HealthKitPermission[];\n  };\n}\n\nexport const healthKitService = {\n  // Initialize and request permissions\n  requestPermissions: () => Promise<boolean>,\n  isAvailable: () => Promise<boolean>,\n  \n  // Sync cardiovascular data\n  syncCardiovascularMetrics: (startDate: Date, endDate: Date) => Promise<HealthMetric[]>,\n  // - HKQuantityTypeIdentifierRestingHeartRate → RESTING_HEART_RATE\n  // - HKQuantityTypeIdentifierHeartRate → instantaneous HR samples\n  // - HKQuantityTypeIdentifierHeartRateVariabilitySDNN → HEART_RATE_VARIABILITY_SDNN\n  // - HKQuantityTypeIdentifier.heartRateVariabilityRMSSD (if available)\n  \n  // Sync respiratory data\n  syncRespiratoryMetrics: (startDate: Date, endDate: Date) => Promise<HealthMetric[]>,\n  // - HKQuantityTypeIdentifierRespiratoryRate → RESPIRATORY_RATE\n  // - HKQuantityTypeIdentifierOxygenSaturation → OXYGEN_SATURATION\n  // - HKQuantityTypeIdentifierVO2Max → VO2_MAX\n  \n  // Sync sleep data\n  syncSleepMetrics: (startDate: Date, endDate: Date) => Promise<HealthMetric[]>,\n  // - HKCategoryTypeIdentifierSleepAnalysis → parse into:\n  //   - SLEEP_DURATION (total sleep time)\n  //   - DEEP_SLEEP_DURATION (deep/core sleep stages)\n  //   - REM_SLEEP_DURATION (REM stages)\n  //   - SLEEP_EFFICIENCY (time asleep / time in bed)\n  //   - SLEEP_SCORE (if available from source)\n  \n  // Sync activity data\n  syncActivityMetrics: (startDate: Date, endDate: Date) => Promise<HealthMetric[]>,\n  // - HKQuantityTypeIdentifierStepCount → STEPS\n  // - HKQuantityTypeIdentifierActiveEnergyBurned → ACTIVE_CALORIES\n  // - HKWorkoutType → Activity model with exercise HR data\n  \n  // Background sync\n  setupBackgroundSync: () => void,\n}\n```\n\n4. HealthKit type identifiers mapping:\n```typescript\nconst HEALTHKIT_TYPE_MAP = {\n  // Cardiovascular\n  HKQuantityTypeIdentifierRestingHeartRate: 'RESTING_HEART_RATE',\n  HKQuantityTypeIdentifierHeartRateVariabilitySDNN: 'HEART_RATE_VARIABILITY_SDNN',\n  // Note: RMSSD might need manual calculation from RR intervals\n  \n  // Respiratory\n  HKQuantityTypeIdentifierRespiratoryRate: 'RESPIRATORY_RATE',\n  HKQuantityTypeIdentifierOxygenSaturation: 'OXYGEN_SATURATION',\n  HKQuantityTypeIdentifierVO2Max: 'VO2_MAX',\n  \n  // Sleep (requires parsing HKCategoryTypeIdentifierSleepAnalysis)\n  // Sleep stages: inBed, asleepUnspecified, awake, asleepCore, asleepDeep, asleepREM\n  \n  // Activity\n  HKQuantityTypeIdentifierStepCount: 'STEPS',\n  HKQuantityTypeIdentifierActiveEnergyBurned: 'ACTIVE_CALORIES',\n};\n```\n\n5. Implement data transformation layer:\n   - Convert HealthKit units to API units (bpm, ms, %, steps, kcal, etc.)\n   - Match existing Zod validation schemas in `server/src/validation/schemas.ts`\n   - Use source: 'apple_health' to match healthMetricSourceSchema\n   - Include device metadata: {device: \"Apple Watch\", quality: \"high\"}\n\n6. Create sync flow:\n   - Initial sync: Fetch last 30 days of data on first connect\n   - Incremental sync: Fetch data since last sync timestamp\n   - Store lastSyncTimestamp in Expo SecureStore (per metric type for efficiency)\n   - Batch API calls using bulkCreateHealthMetricsSchema (50 items per request)\n   - Handle timezone conversions (HealthKit returns local time, API expects UTC)\n\n7. Handle data deduplication:\n   - Use existing (userId, metricType, recordedAt, source) unique constraint in schema\n   - Server handles conflicts via upsert\n   - Store sourceId from HealthKit sample UUID for traceability\n\n8. Add sync UI in profile settings (app/profile.tsx or new app/settings/health.tsx):\n   - Connect/Disconnect Apple Health button\n   - Permission status for each metric category\n   - Last sync timestamp display (per category)\n   - Manual sync button with progress indicator\n   - Sync status indicator (syncing, synced, error)\n   - Data preview showing recently synced metrics\n\n9. Handle background sync (future enhancement):\n   - Configure iOS background fetch capability\n   - Sync when app becomes active via AppState listener\n   - Respect battery and data usage settings\n   - Consider using HealthKit's HKObserverQuery for real-time updates",
        "testStrategy": "1. Unit tests for HealthKit service:\n   - Mock react-native-health module for simulator testing\n   - Test permission request flow and error handling\n   - Test data transformation for each metric type (HK format → API format)\n   - Test unit conversions (HK units → standard units)\n\n2. Test cardiovascular data sync:\n   - Mock RHR samples → verify RESTING_HEART_RATE records\n   - Mock HRV samples → verify HEART_RATE_VARIABILITY_SDNN records\n   - Test edge cases: missing data, invalid values\n\n3. Test respiratory data sync:\n   - Mock respiratory rate → verify RESPIRATORY_RATE records\n   - Mock SpO2 → verify OXYGEN_SATURATION records\n   - Mock VO2Max → verify VO2_MAX records\n\n4. Test sleep data parsing:\n   - Mock sleep analysis categories → verify correct stage classification\n   - Test sleep efficiency calculation (time asleep / time in bed)\n   - Test sleep duration aggregation across fragmented sleep\n\n5. Test sync error handling and retry logic:\n   - Network errors during bulk upload\n   - Partial failures in batch operations\n   - Permission denied scenarios\n\n6. Test deduplication with existing data:\n   - Re-sync same data → verify no duplicates\n   - Test sourceId matching\n\n7. Test UI state updates during sync:\n   - Loading states\n   - Progress indication\n   - Error display\n\n8. Manual testing on physical device:\n   - Test with real Apple Watch data\n   - Verify data accuracy against Health app\n   - Test permission prompts\n   - Test background sync behavior",
        "subtasks": [
          {
            "id": 1,
            "title": "Install and configure react-native-health package",
            "description": "Add react-native-health dependency and configure iOS build settings with proper entitlements and Info.plist descriptions",
            "dependencies": [],
            "details": "Install react-native-health via npm/yarn. Update app.json with NSHealthShareUsageDescription explaining why the app needs read access to health data. Add HealthKit entitlement. Configure iOS build to include HealthKit framework. Test that the package builds correctly on iOS simulator/device.",
            "status": "pending",
            "testStrategy": "Verify package installs without errors. Confirm iOS build succeeds. Check Info.plist contains correct health usage descriptions.",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Create HealthKit permission management system",
            "description": "Implement permission request flow for all required HealthKit data types including cardiovascular, respiratory, and sleep metrics",
            "dependencies": [
              1
            ],
            "details": "Create lib/services/healthkit/permissions.ts. Define permission sets for each metric category. Implement isAvailable() check for HealthKit. Implement requestPermissions() with granular permission requests. Handle partial permission grants gracefully. Store permission status in context/state.",
            "status": "pending",
            "testStrategy": "Mock HealthKit permissions. Test all permission states (granted, denied, not determined). Test partial permission scenarios.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Implement cardiovascular metrics sync (RHR, HR, HRV)",
            "description": "Create sync functions for Resting Heart Rate, Heart Rate samples, and Heart Rate Variability (SDNN and RMSSD)",
            "dependencies": [
              2
            ],
            "details": "Implement syncCardiovascularMetrics() in healthkit.ts. Query HKQuantityTypeIdentifierRestingHeartRate for RHR. Query HKQuantityTypeIdentifierHeartRateVariabilitySDNN for HRV. Transform HealthKit samples to match HealthMetric API format. Handle unit conversions (HK returns bpm/ms). Include device metadata from sample source.",
            "status": "pending",
            "testStrategy": "Mock HK cardiovascular queries. Verify correct transformation to RESTING_HEART_RATE and HEART_RATE_VARIABILITY_SDNN types. Test unit handling.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Implement respiratory metrics sync (respiratory rate, SpO2, VO2Max)",
            "description": "Create sync functions for respiratory rate, oxygen saturation, and VO2Max data from HealthKit",
            "dependencies": [
              2
            ],
            "details": "Implement syncRespiratoryMetrics() in healthkit.ts. Query HKQuantityTypeIdentifierRespiratoryRate, HKQuantityTypeIdentifierOxygenSaturation, and HKQuantityTypeIdentifierVO2Max. Transform to RESPIRATORY_RATE, OXYGEN_SATURATION, and VO2_MAX metric types. Handle different sample frequencies (VO2Max is less frequent).",
            "status": "pending",
            "testStrategy": "Mock HK respiratory queries. Verify correct transformation to API format. Test handling of sparse VO2Max data.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Implement sleep metrics sync with stage classification",
            "description": "Create sync function for sleep analysis including duration, deep sleep, REM, and efficiency calculations",
            "dependencies": [
              2
            ],
            "details": "Implement syncSleepMetrics() in healthkit.ts. Query HKCategoryTypeIdentifierSleepAnalysis. Parse sleep stages (asleepCore→DEEP_SLEEP, asleepDeep→DEEP_SLEEP, asleepREM→REM_SLEEP). Calculate total SLEEP_DURATION. Calculate SLEEP_EFFICIENCY (asleep time / in bed time). Handle fragmented sleep sessions.",
            "status": "pending",
            "testStrategy": "Mock HK sleep analysis with various stage combinations. Verify correct duration calculations. Test efficiency calculation accuracy. Test fragmented sleep handling.",
            "parentId": "undefined"
          },
          {
            "id": 6,
            "title": "Implement activity metrics sync (steps, active calories)",
            "description": "Create sync function for daily activity data including step count and active energy burned",
            "dependencies": [
              2
            ],
            "details": "Implement syncActivityMetrics() in healthkit.ts. Query HKQuantityTypeIdentifierStepCount and HKQuantityTypeIdentifierActiveEnergyBurned. Aggregate daily totals. Transform to STEPS and ACTIVE_CALORIES metric types. Handle timezone boundaries for daily aggregation.",
            "status": "pending",
            "testStrategy": "Mock HK activity queries. Verify daily aggregation logic. Test timezone handling for day boundaries.",
            "parentId": "undefined"
          },
          {
            "id": 7,
            "title": "Create batch sync orchestration with API integration",
            "description": "Implement the main sync orchestration that coordinates all metric syncs and uploads to the backend API",
            "dependencies": [
              3,
              4,
              5,
              6
            ],
            "details": "Create syncAllHealthData() coordinator function. Implement incremental sync using stored lastSyncTimestamp from SecureStore. Batch API uploads using bulkCreateHealthMetricsSchema (50 items per request). Handle partial failures and retry logic. Update lastSyncTimestamp per metric category on success.",
            "status": "pending",
            "testStrategy": "Test full sync orchestration flow. Verify batch chunking at 50 items. Test incremental sync with stored timestamps. Test error handling and retry.",
            "parentId": "undefined"
          },
          {
            "id": 8,
            "title": "Build HealthKit settings UI with sync controls",
            "description": "Create the user interface for managing HealthKit connection, viewing sync status, and triggering manual syncs",
            "dependencies": [
              7
            ],
            "details": "Create app/settings/health.tsx screen or add section to app/profile.tsx. Display Connect/Disconnect Apple Health button. Show permission status per metric category with toggle indicators. Display last sync timestamp and synced data counts. Add manual Sync Now button with progress indicator. Show sync status (syncing/synced/error) with appropriate feedback.",
            "status": "pending",
            "testStrategy": "Test UI component rendering. Test connect/disconnect flow. Test sync button interaction and loading states. Test error state display.",
            "parentId": "undefined"
          }
        ],
        "complexity": 8,
        "recommendedSubtasks": 7,
        "expansionPrompt": "Break down the Apple HealthKit integration into implementation phases:\n\n1. **Library Setup & Configuration**: Install react-native-health or expo-health-connect, configure iOS entitlements in app.json (NSHealthShareUsageDescription), and set up the Expo plugin. Research which library works best with Expo SDK 52.\n\n2. **HealthKit Service Core**: Create `lib/services/healthkit.ts` with typed interfaces matching the existing TypeScript patterns in `lib/types/index.ts`. Implement the base service structure with permission request methods.\n\n3. **Data Fetching Implementation**: Implement data fetching for each metric type mapping HealthKit identifiers to the existing HealthMetricType enum (RESTING_HEART_RATE, HEART_RATE_VARIABILITY_SDNN, SLEEP_DURATION, STEPS, ACTIVE_CALORIES). Note: Add ACTIVE_HEART_RATE to schema.prisma for instantaneous HR.\n\n4. **Activity Sync Implementation**: Map HKWorkoutType to the existing ActivityType enum (RUNNING, CYCLING, SWIMMING, etc.) in schema.prisma. Handle activity data transformation.\n\n5. **Sync Logic & State Management**: Implement initial sync (30 days), incremental sync with lastSyncTimestamp stored in SecureStore (pattern from lib/api/client.ts), batch API calls (50 items/request), and leverage the existing bulk endpoint at `/api/health-metrics/bulk`.\n\n6. **Profile UI Integration**: Extend the existing `app/(tabs)/profile.tsx` with a Health Integration section. Add Connect/Disconnect Apple Health button, sync status indicators, last sync timestamp display, and manual sync button following the existing design patterns.\n\n7. **Testing & Error Handling**: Mock HealthKit data for simulator, test permission flows, data transformation, sync error handling/retry logic, and UI state updates. Follow existing error handling patterns in lib/utils/errorHandling.ts.",
        "updatedAt": "2025-12-04T21:22:52.954Z"
      },
      {
        "id": "6",
        "title": "Train and Deploy LSTM Models for Health Predictions",
        "description": "Train LSTM models for RHR and HRV prediction using the existing model architecture in ml-service/app/ml_models/lstm.py and make them production-ready.",
        "details": "1. Create training pipeline in `ml-service/app/services/model_training.py`:\n   - Already has TrainModelRequest/Response schemas\n   - Implement data loading from database\n   - Create training/validation split (80/20)\n   - Add early stopping with patience=10\n   - Save model checkpoints and metadata\n\n2. Training data preparation:\n   - Use FeatureEngineeringService to generate features\n   - Create sliding window sequences (30-day windows)\n   - Normalize features using StandardScaler (save scaler with model)\n   - Handle missing data: forward-fill then drop incomplete sequences\n\n3. Training configuration:\n   - RHR model: hidden_dim=128, num_layers=2, dropout=0.2\n   - HRV model: hidden_dim=128, num_layers=2, dropout=0.2\n   - Batch size: 32, learning rate: 0.001\n   - Use Adam optimizer, MSE loss\n   - Train for max 100 epochs with early stopping\n\n4. Model evaluation metrics:\n   - MAE (Mean Absolute Error)\n   - RMSE (Root Mean Square Error)\n   - R² score (>0.5 for production)\n   - MAPE (Mean Absolute Percentage Error, <15% for production)\n\n5. Update PredictionService in `ml-service/app/services/prediction.py`:\n   - Load trained model from disk\n   - Load corresponding scaler\n   - Prepare input sequence from recent features\n   - Run inference and denormalize output\n   - Calculate confidence intervals\n\n6. Model storage structure:\n```\nml-service/models/\n  {user_id}_{metric}_{timestamp}/\n    model.pt              # PyTorch model weights\n    scaler.pkl           # Feature scaler\n    metadata.pkl         # Training config and metrics\n```\n\n7. Add minimum data requirements:\n   - At least 30 days of health data\n   - At least 21 days of nutrition data\n   - Check requirements before training",
        "testStrategy": "1. Unit tests for data preparation pipeline\n2. Test training with synthetic data (verify loss decreases)\n3. Test model save/load roundtrip\n4. Test prediction accuracy on held-out test set\n5. Integration test: full train -> predict flow\n6. Test minimum data requirement validation\n7. Test early stopping triggers correctly",
        "priority": "high",
        "dependencies": [
          "3",
          "5"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "7",
        "title": "Create Predictions Visualization Mobile UI",
        "description": "Build mobile screens to display ML predictions (RHR, HRV forecasts) with confidence intervals and historical context.",
        "details": "1. Create new screens:\n   - `app/predictions/index.tsx` - Predictions dashboard\n   - `app/predictions/[metric].tsx` - Detailed prediction view\n\n2. Predictions Dashboard (`app/predictions/index.tsx`):\n   - Card for each predictable metric (RHR, HRV)\n   - Display: predicted value, confidence score, direction indicator\n   - Comparison to 30-day average\n   - 'No prediction available' state if model not trained\n   - Pull-to-refresh to get latest predictions\n\n3. Detailed Prediction View (`app/predictions/[metric].tsx`):\n   - Chart showing:\n     - Historical values (last 30 days)\n     - Predicted value for tomorrow\n     - Confidence interval as shaded region\n   - Interpretation text (AI-generated explanation)\n   - Recommendation based on prediction\n   - Feature importance breakdown (what drove this prediction)\n\n4. Create API client in `lib/api/predictions.ts`:\n```typescript\nexport const predictionsApi = {\n  predict: (metric: string, targetDate: string) =>\n    apiClient.post('/api/predictions/predict', { metric, target_date: targetDate }),\n  batchPredict: (metrics: string[], targetDate: string) =>\n    apiClient.post('/api/predictions/batch-predict', { metrics, target_date: targetDate }),\n  listModels: () => apiClient.get('/api/predictions/models'),\n}\n```\n\n5. Chart implementation:\n   - Use Victory Native or react-native-chart-kit\n   - Line chart for historical + predicted\n   - Shaded area for confidence interval\n   - Animate prediction point\n\n6. Handle states:\n   - Loading: Show skeleton\n   - No model trained: Show CTA to collect more data\n   - Prediction available: Show full UI\n   - Error: Show error message with retry",
        "testStrategy": "1. Component tests for dashboard and detail screens\n2. Test chart rendering with mock data\n3. Test loading/error/empty states\n4. Test confidence interval visualization\n5. Test API integration with mock responses\n6. Snapshot tests for consistent UI",
        "priority": "medium",
        "dependencies": [
          "6"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "8",
        "title": "Implement ML Insights Engine and Recommendations",
        "description": "Build the insights generation system that analyzes correlations and generates personalized nutrition recommendations stored in MLInsight model.",
        "details": "1. Create insights service in `ml-service/app/services/insights_engine.py`:\n```python\nclass InsightsEngine:\n    async def generate_insights(self, user_id: str) -> List[MLInsight]:\n        correlations = await self._get_significant_correlations(user_id)\n        predictions = await self._get_recent_predictions(user_id)\n        anomalies = await self._detect_anomalies(user_id)\n        \n        insights = []\n        insights.extend(self._correlation_insights(correlations))\n        insights.extend(self._prediction_insights(predictions))\n        insights.extend(self._anomaly_insights(anomalies))\n        insights.extend(self._goal_progress_insights(user_id))\n        \n        return self._prioritize_and_limit(insights, max_insights=5)\n```\n\n2. Insight types to implement:\n   - CORRELATION: 'Your protein intake correlates with better HRV (+0.65)'\n   - PREDICTION: 'Tomorrow's RHR is predicted higher than average'\n   - ANOMALY: 'Your sleep duration last night was unusually low'\n   - RECOMMENDATION: 'Try eating dinner earlier to improve sleep quality'\n   - GOAL_PROGRESS: 'You're 80% of the way to your protein goal this week'\n   - PATTERN_DETECTED: 'You tend to eat more carbs on weekends'\n\n3. Correlation-based recommendations:\n   - Use CorrelationEngineService to find significant correlations\n   - Filter by correlation strength (|r| > 0.5)\n   - Generate natural language recommendations\n   - Example: If protein ↔ HRV has r=0.7, recommend 'Increasing protein may improve your HRV'\n\n4. Anomaly detection:\n   - Z-score based detection (>2 std from 30-day mean)\n   - Detect unusual: meal timing, calorie intake, sleep duration\n   - Generate alerts for negative anomalies\n\n5. Create API endpoints in `ml-service/app/api/insights.py`:\n   - GET /api/insights - List user's active insights\n   - POST /api/insights/generate - Trigger insight generation\n   - PUT /api/insights/{id}/viewed - Mark as viewed\n   - PUT /api/insights/{id}/dismissed - Dismiss insight\n   - PUT /api/insights/{id}/feedback - Submit helpful/not helpful\n\n6. Store insights in database using MLInsight model (already defined in Prisma schema)",
        "testStrategy": "1. Unit tests for each insight type generator\n2. Test insight prioritization logic\n3. Test anomaly detection thresholds\n4. Test natural language generation\n5. Integration test: end-to-end insight generation\n6. Test user feedback tracking\n7. Test insight expiration handling",
        "priority": "medium",
        "dependencies": [
          "6"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "9",
        "title": "Build Insights Feed Mobile UI",
        "description": "Create mobile screens to display ML-generated insights, recommendations, and allow user feedback.",
        "details": "1. Create new screens:\n   - `app/insights/index.tsx` - Insights feed/dashboard\n   - `app/insights/[id].tsx` - Detailed insight view\n\n2. Insights Feed (`app/insights/index.tsx`):\n   - List of insight cards sorted by priority and recency\n   - Card components per insight type:\n     - Correlation: Show correlation strength badge\n     - Prediction: Show predicted value and arrow\n     - Anomaly: Show warning indicator\n     - Recommendation: Show actionable tip\n   - Swipe to dismiss functionality\n   - Pull-to-refresh to generate new insights\n   - Empty state: 'Keep logging meals to unlock insights'\n\n3. Insight Card Design:\n```typescript\ninterface InsightCard {\n  icon: string;           // Based on insightType\n  title: string;          // From insight.title\n  description: string;    // Truncated insight.description\n  priority: 'high' | 'medium' | 'low'; // Color coding\n  correlation?: number;   // Show badge if correlation insight\n  timestamp: Date;        // When generated\n}\n```\n\n4. Detailed Insight View (`app/insights/[id].tsx`):\n   - Full description text\n   - Recommendation with call-to-action\n   - Supporting chart/data if applicable\n   - 'Was this helpful?' feedback buttons\n   - Share insight button (future)\n\n5. Create API client in `lib/api/insights.ts`:\n```typescript\nexport const insightsApi = {\n  getAll: () => apiClient.get('/api/insights'),\n  getById: (id: string) => apiClient.get(`/api/insights/${id}`),\n  markViewed: (id: string) => apiClient.put(`/api/insights/${id}/viewed`),\n  dismiss: (id: string) => apiClient.put(`/api/insights/${id}/dismissed`),\n  submitFeedback: (id: string, helpful: boolean) =>\n    apiClient.put(`/api/insights/${id}/feedback`, { helpful }),\n}\n```\n\n6. Add insights badge to tab bar showing unread count",
        "testStrategy": "1. Component tests for insight cards\n2. Test swipe-to-dismiss interaction\n3. Test feedback submission flow\n4. Test empty and loading states\n5. Test priority-based sorting\n6. Visual regression tests for card styles",
        "priority": "medium",
        "dependencies": [
          "8"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "10",
        "title": "Implement AR Portion Size Measurement",
        "description": "Add AR capability to measure food portion dimensions and improve nutrition estimation accuracy.",
        "details": "1. Install AR dependencies:\n   - expo-three (already installed - three.js is in dependencies)\n   - expo-gl (already installed)\n   - @react-three/fiber for React Native\n\n2. Create AR measurement component in `lib/components/ARPortionMeasure.tsx`:\n   - Initialize AR session with plane detection\n   - Render measurement guides on detected surfaces\n   - Allow user to place measurement points\n   - Calculate bounding box dimensions (width, height, depth)\n   - Return dimensions in centimeters\n\n3. Update food scanning flow (`app/scan-food.tsx`):\n   - Add 'Measure with AR' button after capturing photo\n   - Launch AR measurement overlay\n   - Pass dimensions to food analysis API\n   - Update `mockMeasurements` with real AR data\n\n4. AR measurement flow:\n   1. User captures food photo\n   2. User taps 'Measure Portion'\n   3. AR view opens with plane detection\n   4. User taps to place corner points (4 points for bounding box)\n   5. App calculates volume and converts to portion weight\n   6. Dimensions sent to /api/food/analyze\n\n5. Dimension to weight conversion (in food_analysis_service.py):\n   - Already implemented in `_estimate_portion_from_dimensions()`\n   - Uses food density estimates\n   - Returns estimated weight in grams\n\n6. Calibration feature:\n   - Include reference object option (credit card, hand)\n   - Use known dimensions to calibrate scale\n   - Improve accuracy for subsequent measurements\n\n7. Fallback handling:\n   - If AR not supported (older devices), show manual size picker\n   - Options: Small, Medium, Large with example photos",
        "testStrategy": "1. Unit tests for dimension calculation\n2. Test AR component mounting/unmounting\n3. Test plane detection callbacks\n4. Integration test with mock AR data\n5. Test fallback to manual size picker\n6. Manual testing on physical device with AR support\n7. Test calibration accuracy with known objects",
        "priority": "low",
        "dependencies": [
          "2"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "11",
        "title": "Generate OpenAPI Documentation and Polish Production Readiness",
        "description": "Add comprehensive API documentation, perform security audit, and optimize performance for production deployment.",
        "details": "1. Generate OpenAPI/Swagger documentation:\n   - Backend (Express): Add swagger-jsdoc and swagger-ui-express\n   - ML Service (FastAPI): Already has built-in docs at /docs\n   - Document all endpoints with request/response schemas\n   - Add authentication requirements\n   - Include example requests and responses\n\n2. Express API documentation setup:\n```javascript\nimport swaggerJsdoc from 'swagger-jsdoc';\nimport swaggerUi from 'swagger-ui-express';\n\nconst options = {\n  definition: {\n    openapi: '3.0.0',\n    info: { title: 'Nutri API', version: '1.0.0' },\n    servers: [{ url: '/api' }],\n    components: {\n      securitySchemes: {\n        bearerAuth: { type: 'http', scheme: 'bearer' }\n      }\n    }\n  },\n  apis: ['./src/routes/*.ts'],\n};\n\napp.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerJsdoc(options)));\n```\n\n3. Performance optimization:\n   - Add database query logging to identify slow queries\n   - Implement connection pooling for PostgreSQL\n   - Add Redis caching for frequently accessed data (user profile, daily summary)\n   - Compress API responses with compression middleware\n   - Optimize Prisma queries with select/include\n\n4. Security audit checklist:\n   - Review all authentication flows\n   - Verify rate limiting is effective\n   - Check for SQL injection (Prisma handles this)\n   - Verify XSS prevention in sanitize middleware\n   - Review CORS configuration\n   - Ensure sensitive data not logged\n   - Check JWT secret rotation capability\n\n5. Production configuration:\n   - Environment variable validation on startup\n   - Health check endpoints for load balancers\n   - Graceful shutdown handling\n   - Error tracking integration (Sentry ready)\n   - Logging configuration (structured JSON logs)\n\n6. Mobile app optimization:\n   - Review bundle size\n   - Implement proper loading states\n   - Add offline detection and handling\n   - Optimize image handling\n\n7. Create deployment documentation:\n   - Docker setup for backend and ML service\n   - Environment variables reference\n   - Database migration guide\n   - Monitoring recommendations",
        "testStrategy": "1. Validate OpenAPI spec with swagger-cli validate\n2. Load testing with k6 or artillery (100 concurrent users)\n3. Security scan with npm audit and OWASP ZAP\n4. Test rate limiting triggers correctly\n5. Test graceful shutdown\n6. Verify logging output format\n7. Test health check endpoints\n8. Performance benchmark for critical endpoints",
        "priority": "low",
        "dependencies": [
          "2",
          "3",
          "4",
          "6"
        ],
        "status": "pending",
        "subtasks": []
      }
    ],
    "metadata": {
      "version": "1.0.0",
      "lastModified": "2025-12-05T01:59:24.617Z",
      "taskCount": 10,
      "completedCount": 1,
      "tags": [
        "master"
      ]
    }
  }
}