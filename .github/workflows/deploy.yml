# =============================================================================
# Nutri Deploy Workflow
# Triggers Coolify webhooks after successful build, verifies health, and notifies
# =============================================================================

name: Deploy

on:
  workflow_run:
    workflows: ["Build and Push"]
    types: [completed]
    branches: [master]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'
      skip_ml_service:
        description: 'Skip ML service deployment'
        required: false
        default: 'false'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deployment info
        run: |
          echo "## ðŸš€ Starting Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ github.event.inputs.image_tag || 'latest' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # -------------------------------------------------------------------------
      # Database Migration (runs before application deployment)
      # -------------------------------------------------------------------------
      - name: Setup Node.js for migrations
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install server dependencies
        run: cd server && npm ci

      - name: Generate Prisma client
        run: cd server && npx prisma generate

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          # DIRECT_URL is needed for Prisma migrations when using connection poolers
          # Falls back to DATABASE_URL if DIRECT_URL secret is not configured
          DIRECT_URL: ${{ secrets.DIRECT_URL || secrets.DATABASE_URL }}
        run: |
          echo "ðŸ—„ï¸ Running database migrations..."
          cd server
          npx prisma migrate deploy
          echo "âœ… Database migrations complete"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Database" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Migrations applied successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # -------------------------------------------------------------------------
      # Application Deployment
      # -------------------------------------------------------------------------
      - name: Trigger Coolify Backend Deployment
        id: deploy-backend
        # Webhook may timeout but deployment still starts - continue on error
        continue-on-error: true
        run: |
          echo "Triggering backend deployment..."

          # Retry logic for transient failures
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3..."

            response=$(curl -s -w "\n%{http_code}" -X POST \
              --connect-timeout 30 \
              --max-time 120 \
              -H "Authorization: Bearer ${{ secrets.COOLIFY_WEBHOOK_SECRET }}" \
              -H "Content-Type: application/json" \
              "${{ secrets.COOLIFY_BACKEND_WEBHOOK_URL }}" 2>/dev/null) || response=$'\n000'

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"
            echo "Response: $body"

            # Success codes
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ] || [ "$http_code" = "202" ]; then
              echo "âœ… Backend deployment triggered successfully"
              echo "backend_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Gateway timeout - deployment may still start
            if [ "$http_code" = "504" ] || [ "$http_code" = "502" ]; then
              echo "âš ï¸ Gateway timeout - deployment may still be processing"
              if [ $attempt -eq 3 ]; then
                echo "backend_status=timeout" >> $GITHUB_OUTPUT
                exit 0  # Don't fail, Coolify may still deploy
              fi
            fi

            # Wait before retry
            if [ $attempt -lt 3 ]; then
              echo "â³ Waiting 10 seconds before retry..."
              sleep 10
            fi
          done

          echo "âŒ Backend deployment trigger failed after 3 attempts"
          echo "backend_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Trigger Coolify ML Service Deployment
        id: deploy-ml
        if: ${{ github.event.inputs.skip_ml_service != 'true' }}
        # Webhook may timeout but deployment still starts - continue on error
        continue-on-error: true
        run: |
          echo "Triggering ML service deployment..."

          # Retry logic for transient failures
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3..."

            response=$(curl -s -w "\n%{http_code}" -X POST \
              --connect-timeout 30 \
              --max-time 120 \
              -H "Authorization: Bearer ${{ secrets.COOLIFY_WEBHOOK_SECRET }}" \
              -H "Content-Type: application/json" \
              "${{ secrets.COOLIFY_ML_WEBHOOK_URL }}" 2>/dev/null) || response=$'\n000'

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"
            echo "Response: $body"

            # Success codes
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ] || [ "$http_code" = "202" ]; then
              echo "âœ… ML service deployment triggered successfully"
              echo "ml_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Gateway timeout - deployment may still start
            if [ "$http_code" = "504" ] || [ "$http_code" = "502" ]; then
              echo "âš ï¸ Gateway timeout - deployment may still be processing"
              if [ $attempt -eq 3 ]; then
                echo "ml_status=timeout" >> $GITHUB_OUTPUT
                exit 0  # Don't fail, Coolify may still deploy
              fi
            fi

            # Wait before retry
            if [ $attempt -lt 3 ]; then
              echo "â³ Waiting 10 seconds before retry..."
              sleep 10
            fi
          done

          echo "âŒ ML service deployment trigger failed after 3 attempts"
          echo "ml_status=failed" >> $GITHUB_OUTPUT
          exit 1

      # -------------------------------------------------------------------------
      # Force Deployment via SSH (workaround for Coolify not starting containers)
      # -------------------------------------------------------------------------
      - name: Force Deploy via SSH
        env:
          SSH_KEY: ${{ secrets.COOLIFY_SSH_KEY }}
          SERVER_IP: ${{ secrets.COOLIFY_SERVER_IP }}
        run: |
          # Skip if SSH key not configured
          if [ -z "$SSH_KEY" ]; then
            echo "â­ï¸ SSH key not configured, skipping direct deployment"
            exit 0
          fi

          echo "ðŸ”§ Forcing deployment via SSH..."

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy backend
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@$SERVER_IP << 'DEPLOY'
          cd /data/coolify/applications/zwogw8ccsw84w8ocws4sowok
          docker compose up -d --remove-orphans
          echo "âœ… Backend container deployed"
          DEPLOY

          # Deploy ML service
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@$SERVER_IP << 'DEPLOY'
          cd /data/coolify/applications/z8cg8kkg4o0wg8044c8g0s0o
          docker compose up -d --remove-orphans 2>/dev/null || echo "ML service path may differ"
          echo "âœ… ML service container deployed"
          DEPLOY

          echo "deployment_method=ssh" >> $GITHUB_OUTPUT

      - name: Wait for containers to start
        run: |
          echo "â³ Waiting 60 seconds for containers to start..."
          sleep 60

      - name: Verify Backend Health
        id: health-backend
        # Health check is best-effort - Coolify's internal healthcheck is authoritative
        # External health checks from GitHub runners may fail due to network/DNS issues
        continue-on-error: true
        run: |
          echo "ðŸ” Checking backend health (best-effort from GitHub runner)..."
          echo "Note: Coolify's internal healthcheck is the authoritative source"
          echo ""

          # Check if PRODUCTION_API_URL is configured
          if [ -z "${{ secrets.PRODUCTION_API_URL }}" ]; then
            echo "âš ï¸ PRODUCTION_API_URL secret not configured, skipping external health check"
            echo "health_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          # First, verify DNS resolution
          echo "Checking DNS resolution for the API URL..."
          API_HOST=$(echo "${{ secrets.PRODUCTION_API_URL }}" | sed -E 's|https?://([^/]+).*|\1|')
          echo "API Host: $API_HOST"
          nslookup "$API_HOST" 2>&1 | head -5 || echo "DNS lookup failed"

          for i in {1..5}; do
            echo "Health check attempt $i/5..."

            # Use /health/live for fast liveness check (doesn't check dependencies)
            # Add -v for first attempt to debug connection issues
            if [ $i -eq 1 ]; then
              curl -v --connect-timeout 10 --max-time 15 \
                "${{ secrets.PRODUCTION_API_URL }}/health/live" 2>&1 | head -30 || true
            fi

            http_code=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 \
              --max-time 15 \
              "${{ secrets.PRODUCTION_API_URL }}/health/live" 2>/dev/null) || http_code="000"

            echo "HTTP Status: $http_code"

            if [ "$http_code" = "200" ]; then
              echo "âœ… Backend is healthy!"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ $i -lt 5 ]; then
              echo "â³ Waiting 15 seconds before next attempt..."
              sleep 15
            fi
          done

          echo "âš ï¸ Could not verify backend health from GitHub runner"
          echo "This may be due to network/DNS issues - check Coolify dashboard for actual status"
          echo "health_status=unreachable" >> $GITHUB_OUTPUT

      - name: Verify ML Service Health (internal check via backend)
        id: health-ml
        if: ${{ github.event.inputs.skip_ml_service != 'true' }}
        continue-on-error: true
        run: |
          echo "ðŸ” Checking ML service health via backend..."

          # ML service health is checked via the backend's /health endpoint
          # which includes an ml_service check when ML_SERVICE_URL is configured
          response=$(curl -s --connect-timeout 5 --max-time 10 \
            "${{ secrets.PRODUCTION_API_URL }}/health" 2>/dev/null || echo "{}")

          echo "Backend health response: $response"

          # Check if ML service is reported in the health response
          if echo "$response" | grep -q "ml_service"; then
            ml_status=$(echo "$response" | grep -o '"ml_service"[^}]*' | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            if [ "$ml_status" = "healthy" ]; then
              echo "âœ… ML service is healthy!"
            else
              echo "âš ï¸ ML service status: $ml_status (may still be starting)"
            fi
          else
            echo "âš ï¸ ML service health not reported (service may not be configured)"
          fi

      - name: Generate deployment summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          # Backend status
          backend_status="${{ steps.health-backend.outputs.health_status }}"
          case "$backend_status" in
            healthy)
              echo "| Backend API | âœ… Verified healthy |" >> $GITHUB_STEP_SUMMARY
              ;;
            skipped)
              echo "| Backend API | â­ï¸ Check skipped (no URL configured) |" >> $GITHUB_STEP_SUMMARY
              ;;
            unreachable)
              echo "| Backend API | âš ï¸ Unreachable from GitHub (check Coolify) |" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "| Backend API | âš ï¸ Unknown status |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          # ML Service status
          echo "| ML Service | ${{ steps.health-ml.outcome == 'success' && 'âœ… Healthy' || 'âš ï¸ Check Coolify dashboard' }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Deployment is successful if webhooks were triggered or timed out
          # (timeout still likely means deployment started on Coolify side)
          backend_deploy="${{ steps.deploy-backend.outputs.backend_status }}"
          ml_deploy="${{ steps.deploy-ml.outputs.ml_status }}"

          if [ "$backend_deploy" = "success" ] || [ "$backend_deploy" = "timeout" ]; then
            if [ "$backend_deploy" = "timeout" ]; then
              echo "âš ï¸ **Deployment triggered (webhook timed out)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> Webhook timed out but deployment likely started." >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸŽ‰ **Deployment triggered successfully!**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** Coolify's internal healthcheck validates service health." >> $GITHUB_STEP_SUMMARY
            echo "> External health checks from GitHub runners are best-effort and may fail due to network issues." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment trigger failed** - Check webhook configuration" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Success Notification
        if: success()
        run: |
          # Skip if no Discord webhook configured
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Deployment Successful",
                "description": "Nutri has been deployed to production",
                "color": 5763719,
                "fields": [
                  {"name": "Commit", "value": "`'"${{ github.sha }}"'`", "inline": true},
                  {"name": "Branch", "value": "master", "inline": true},
                  {"name": "Triggered By", "value": "${{ github.actor }}", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }' || true

      - name: Send Failure Notification
        if: failure()
        run: |
          # Skip if no Discord webhook configured
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Deployment Failed",
                "description": "Nutri deployment to production failed",
                "color": 15548997,
                "fields": [
                  {"name": "Commit", "value": "`'"${{ github.sha }}"'`", "inline": true},
                  {"name": "Workflow Run", "value": "[View Logs]('"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"')", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }' || true

  # ---------------------------------------------------------------------------
  # Rollback Job (manual trigger only)
  # ---------------------------------------------------------------------------
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: deploy
    # Only runs if deploy job fails when using a specific image tag (not latest)
    if: ${{ failure() && github.event_name == 'workflow_dispatch' && github.event.inputs.image_tag != 'latest' }}

    steps:
      - name: Rollback notification
        run: |
          echo "## âš ï¸ Rollback Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment of tag \`${{ github.event.inputs.image_tag }}\` failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To rollback manually:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Via Coolify UI or SSH to server:" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}/backend:<previous-tag>" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}/ml-service:<previous-tag>" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
