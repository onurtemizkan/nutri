name: E2E Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - all
          - auth
          - meals
          - health
          - activity
          - navigation
          - profile
          - validation

env:
  NODE_VERSION: '20'

jobs:
  e2e-tests:
    name: E2E Tests - ${{ inputs.test_suite }}
    runs-on: macos-14
    timeout-minutes: 60

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutri_db
      JWT_SECRET: test-jwt-secret-key-for-ci
      JWT_EXPIRES_IN: 7d
      REDIS_URL: redis://localhost:6379
      NODE_ENV: development
      PORT: 3000

      # Maestro test environment variables
      APP_ID: com.anonymous.nutri
      TEST_EMAIL: testuser@example.com
      TEST_PASSWORD: Test123456
      TEST_NAME: Test User

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install server dependencies
        run: cd server && npm ci

      - name: Install and start PostgreSQL
        run: |
          brew install postgresql@16
          brew services start postgresql@16

          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            if pg_isready -h localhost > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 1
          done

          # Create database
          createdb nutri_db

      - name: Install and start Redis
        run: |
          brew install redis
          brew services start redis

          # Wait for Redis to be ready
          for i in {1..30}; do
            if redis-cli ping > /dev/null 2>&1; then
              echo "Redis is ready!"
              break
            fi
            echo "Waiting for Redis... ($i/30)"
            sleep 1
          done

      - name: Generate Prisma Client
        run: cd server && npx prisma generate

      - name: Run database migrations
        run: cd server && npx prisma migrate deploy

      - name: Create test user
        run: cd server && npx tsx scripts/create-test-user.ts

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install CocoaPods
        run: gem install cocoapods

      - name: Setup iOS Simulator
        run: |
          # List available simulators
          xcrun simctl list devices available

          # Boot iPhone 15 simulator (or latest available)
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')

          if [ -z "$SIMULATOR_ID" ]; then
            echo "iPhone 15 not found, trying iPhone 14..."
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 14" | head -1 | grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')
          fi

          if [ -z "$SIMULATOR_ID" ]; then
            echo "No suitable simulator found!"
            exit 1
          fi

          echo "Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID"

          # Wait for simulator to boot
          while ! xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -q "Booted"; do
            echo "Waiting for simulator to boot..."
            sleep 2
          done

          echo "Simulator booted successfully"

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      - name: Prebuild iOS app
        run: npx expo prebuild --platform ios --clean

      - name: Build iOS app
        run: |
          # Build the app for simulator
          xcodebuild \
            -workspace ios/nutri.xcworkspace \
            -scheme nutri \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            build

      - name: Install app on simulator
        run: |
          # Find the .app bundle
          APP_PATH=$(find ios/build -name "*.app" | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "App bundle not found!"
            exit 1
          fi

          echo "Installing app: $APP_PATH"

          # Get booted simulator ID
          SIMULATOR_ID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')

          # Install app on simulator
          xcrun simctl install "$SIMULATOR_ID" "$APP_PATH"

      - name: Start backend server
        run: |
          cd server && npm start &

          # Wait for server to be ready
          echo "Waiting for backend server..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/health > /dev/null; then
              echo "Backend server is ready!"
              break
            fi
            echo "Attempt $i: Server not ready yet..."
            sleep 2
          done

          # Verify server is running
          curl http://localhost:3000/health

      - name: Run Maestro tests - ${{ inputs.test_suite }}
        run: |
          ./scripts/run-maestro-headless.sh ${{ inputs.test_suite }}

      - name: Upload Maestro test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-results-${{ inputs.test_suite }}
          path: maestro-results/
          retention-days: 30

      - name: Upload iOS app artifact
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ios-app-debug-${{ inputs.test_suite }}
          path: ios/build/Build/Products/Debug-iphonesimulator/
          retention-days: 7

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action/macos@v2
        if: always()
        with:
          files: maestro-results/*.xml
          check_name: E2E Test Results (${{ inputs.test_suite }})
